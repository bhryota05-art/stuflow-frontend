<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StuFlow - Academic Management (FULL-STACK)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- REFINED DARK MODE STYLES (Final Polish) --- */
        body.dark {
            background-color: #0F172A; /* Primary Background */
            color: #E5E7EB; 
        }
        
        /* Card & Sidebar Backgrounds (Elevation) */
        body.dark .bg-gray-50 { background-color: #111827; /* Darker Main Content Area */ }
        body.dark .bg-white { background-color: #1F2937; /* Card Surface & Nav Sidebar (Elevation 1) */ }
        
        /* Nav & Button Hover States */
        body.dark .hover\:bg-gray-50:hover { background-color: #374151; } 

        /* Text Colors */
        body.dark .text-gray-800, body.dark .text-gray-900 { color: #F8FAFC; } /* White/Light */
        body.dark .text-gray-700 { color: #CBD5E1; } /* Lighter Gray for labels */
        body.dark .text-gray-500 { color: #94A3B8; } /* Muted Gray */

        /* Borders and Dividers */
        body.dark .border-gray-100, body.dark .border-gray-200, body.dark .border-gray-300 { border-color: #374151; }
        body.dark .bg-gray-100 { background-color: #374151; } /* For Segmented Controls / Dividers */
        
        /* --- DEEPER SHADOW FIX --- */
        body.dark .shadow-md, body.dark .shadow-sm { 
            /* Stronger, more defined shadow for depth */
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.7), 0 6px 12px -6px rgba(0, 0, 0, 0.5);
        }

        /* Input Fields */
        body.dark input, body.dark textarea, body.dark select { 
            background-color: #1E293B; 
            border-color: #374151;
            color: #F8FAFC;
        }

        body.dark input:focus, body.dark textarea:focus, body.dark select:focus { 
            border-color: #60A5FA;
            ring-color: #60A5FA;
        }

        /* Disabled Input Fields (e.g., Email) */
        body.dark input:disabled {
            background-color: #111827; /* Darker than main surface */
            color: #6B7280;
        }

        /* --- SPECIFIC DARK MODE COMPONENT FIXES --- */

        /* Urgent Task/Deadline Card Background Fix */
        body.dark .bg-red-50 { 
            background-color: #3C2D32 !important; /* Darker, desaturated red background */
            border-color: #7F1D1D !important; /* Deep red border */
            color: #FCA5A5 !important; /* Light red text for contrast */
        }
        body.dark .bg-red-50 .text-gray-800 { color: #F8FAFC !important; }
        body.dark .bg-red-50 .text-gray-500 { color: #FCA5A5 !important; }

        /* Eco Badges / Utility Accent Adaptation (CONVERTED FROM GREEN TO BLUE) */
        body.dark .bg-blue-50 { background-color: #1E3A8A; border-color: #1D4ED8; color: #DBEAFE; } /* Deep Blue (Replaced green-50) */
        body.dark .bg-yellow-50 { background-color: #713F12; border-color: #A16207; color: #FDE68A; } /* Deep Yellow/Amber */
        body.dark .bg-blue-100 { background-color: #3B82F620; }
        
        /* Active Nav Link Adaptation */
        body.dark .bg-blue-50 { 
            background-color: #334155 !important; 
        }
        body.dark .text-blue-700 { 
            color: #93C5FD !important; 
        }
        body.dark .text-gray-600 { /* Inactive nav text */
             color: #E2E8F0;
        }
        
        /* Calendar Today Highlight Fix */
        body.dark .bg-blue-600 { background-color: #60A5FA; } /* Lighter blue for better contrast on dark */


        /* --- PROFESSIONAL DARK MODE TOGGLE SWITCH STYLING (CONVERTED FROM TEAL TO BLUE) --- */
        .theme-switch-container {
            width: 60px;
            height: 32px;
            background-color: #D1D5DB; /* Light grey track in light mode */
            border-radius: 9999px;
            position: relative;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            border: 1px solid #D1D5DB;
        }
        .theme-switch-container .icon {
            position: absolute;
            width: 24px;
            height: 24px;
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4B5563; /* Icon color in light mode */
        }
        .theme-switch-container .slider {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: white; /* White thumb in light mode */
            border-radius: 9999px;
            transition: transform 0.3s;
            z-index: 10;
        }

        /* LIGHT MODE INITIAL STATE */
        .icon-sun { left: 4px; opacity: 1; }
        .icon-moon { left: 4px; opacity: 0; }
        .theme-switch-container .slider { transform: translateX(0); }

        /* DARK MODE STATE (When body.dark is applied) */
        body.dark .theme-switch-container {
            background-color: #2563EB; /* Blue-600 track in dark mode (Replaced Teal/Green) */
            border-color: #2563EB;
        }
        body.dark .theme-switch-container .slider {
            transform: translateX(24px); /* Move thumb to the right */
            background-color: #1F2937; /* Dark slate thumb */
        }
        body.dark .icon-sun { opacity: 0; }
        body.dark .icon-moon { opacity: 1; }
        
        /* Ensure icons are correctly positioned inside the track */
        .icon-sun { left: 4px; }
        .icon-moon { left: 4px; }
        /* End Dark Mode Toggle Switch Styling */


        /* OTP Input Styling */
        .otp-input:focus { outline: none; border-color: #2563eb; ring: 2px; }
        
        /* Toast Animation */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms ease-out; }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 300ms ease-in; }

        /* Modal specific styles */
        .modal { transition: opacity 0.3s ease-out; }
        .modal-content { transition: transform 0.3s ease-out; }
        .hidden-modal { opacity: 0; pointer-events: none; }
        .hidden-modal .modal-content { transform: translateY(20px); }
        .active-modal { opacity: 1; pointer-events: auto; }
        .active-modal .modal-content { transform: translateY(0); }

        /* Calendar Indicator Styles */
        .event-indicator::after {
            content: '';
            display: block;
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            border-radius: 50%;
        }

        .type-Event::after { background-color: #2563eb; /* Blue-600 */ }
        .type-Deadline::after { background-color: #f97316; /* Orange-600 */ }
        .type-Exam::after { background-color: #dc2626; /* Red-600 */ }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased overflow-x-hidden">

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <div id="app">
        
        <div id="view-loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
                <p class="text-gray-500 font-medium">Loading StuFlow...</p>
            </div>
        </div>

<div id="view-auth" class="hidden min-h-screen flex flex-col md:flex-row bg-white">
            <div class="hidden md:flex w-1/2 bg-blue-600 text-white p-12 flex-col justify-between relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                            <i data-lucide="book-open" class="text-blue-600 w-6 h-6"></i>
                        </div>
                        <span class="font-bold text-2xl tracking-tight">StuFlow</span>
                    </div>
                    <h1 class="text-5xl font-bold leading-tight mb-6">Manage your academic life with ease.</h1>
                    <p class="text-blue-100 text-lg max-w-md">The complete platform for students and teachers to collaborate, track progress, and achieve goals.</p>
                </div>
                <div class="absolute top-0 right-0 w-96 h-96 bg-blue-500 rounded-full translate-x-1/2 -translate-y-1/2 opacity-50"></div>
                <div class="absolute bottom-0 left-0 w-64 h-64 bg-indigo-600 rounded-full -translate-x-1/3 translate-y-1/3 opacity-50"></div>
            </div>

            <div class="w-full md:w-1/2 flex items-center justify-center p-8 relative">
                <div class="w-full max-w-md space-y-8 fade-in">
                    
                    <div id="form-login">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-gray-900">Welcome back</h2>
                            <p class="mt-2 text-gray-500">Please enter your details to sign in.</p>
                        </div>
                        <form id="loginForm" class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input type="email" id="login-email" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="you@example.com" value="student@stuflow.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            
                                <input type="password" id="login-password" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="••••••••" value="password">
                            </div>
                            <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center">
                                <span class="btn-text">Sign In</span>
                                <span class="loader hidden animate-spin ml-2 h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                            </button>
                        </form>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Don't have an account? <button onclick="switchAuth('signup')" class="text-blue-600 font-bold hover:underline">Sign up</button>
                        </p>
                    </div>

                    <div id="form-signup" class="hidden">
                        <div class="text-center mb-8">
                            <h2 class="text-3xl font-bold text-gray-900">Create Account</h2>
                            <p class="mt-2 text-gray-500">Join StuFlow today.</p>
                        </div>
                        <form id="signupForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="signup-name" required class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none focus:border-blue-500" placeholder="John Doe">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">I am a...</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div onclick="selectRole('student')" id="role-student" class="cursor-pointer p-3 rounded-lg border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold text-center transition-all">Student</div>
                                    <div onclick="selectRole('teacher')" id="role-teacher" class="cursor-pointer p-3 rounded-lg border-2 border-gray-200 text-gray-500 hover:border-gray-300 text-center transition-all">Teacher</div>
                                </div>
                                <input type="hidden" id="signup-role" value="student">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                                <input type="email" id="signup-email" required class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none focus:border-blue-500" placeholder="you@example.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            
                                <input type="password" id="signup-password" required class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none focus:border-blue-500" placeholder="••••••••">
                            </div>
                            <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center">
                                <span class="btn-text">Create Account</span>
                                <span class="loader hidden animate-spin ml-2 h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>
                            </button>
                        </form>
                        <p class="text-center text-sm text-gray-600 mt-6">
                            Already have an account? <button onclick="switchAuth('login')" class="text-blue-600 font-bold hover:underline">Log in</button>
                        </p>
                    </div>

                </div>
            </div>
        </div>

        <div id="view-verification" class="hidden min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4">
            <div class="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center fade-in">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="shield-check" class="text-blue-600 w-8 h-8"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Verification Required</h2>
                <p class="text-gray-500 mb-8">
                    We sent a temporary code to your email.
                </p>

                <div class="flex gap-2 justify-center my-6" id="otp-container">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-lg transition-colors">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-lg transition-colors">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-lg transition-colors">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-lg transition-colors">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-lg transition-colors">
                    <input type="text" maxlength="1" class="otp-input w-12 h-14 text-center text-2xl font-bold border-2 border-gray-200 rounded-lg transition-colors">
                </div>

                <div class="mt-6 text-sm text-gray-500">
                    Didn't receive code? <button onclick="resendVerificationCode()" class="text-blue-600 font-semibold hover:underline">Resend</button>
                </div>
                <button onclick="logout()" class="mt-8 text-gray-400 hover:text-gray-600 text-sm flex items-center justify-center gap-1 w-full">
                    Back to Login
                </button>
            </div>
        </div>

        <div id="view-dashboard" class="hidden min-h-screen bg-gray-50 flex">
<aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col fixed h-full z-10">
                <div class="p-6 border-b border-gray-100 flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="book-open" class="text-white w-5 h-5"></i>
                    </div>
                    <span class="font-bold text-xl text-gray-800">StuFlow</span>
                </div>
                
                <nav id="dynamic-nav" class="flex-1 p-4 space-y-2">
                    </nav>

                <div class="p-4 border-t border-gray-100">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold" id="user-avatar">U</div>
                        <div class="overflow-hidden">
                            <p class="text-sm font-semibold text-gray-700 truncate" id="user-name-display">User Name</p>
                            <p class="text-xs text-gray-500 capitalize" id="user-role-display">Role</p>
                        </div>
                    </div>
                    <button onclick="logout()" class="flex items-center gap-2 text-red-600 hover:bg-red-50 w-full p-2 rounded-lg text-sm font-medium transition-colors">
                        <i data-lucide="log-out" class="w-4 h-4"></i> Sign Out
                    </button>
                </div>
            </aside>

            <main class="flex-1 md:ml-64 p-6 pt-20 md:pt-8">
                </main>
        </div>

    </div>
<div id="event-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Add New Event</h3>
                    <p class="text-sm text-gray-500">Create a new event, exam, or deadline</p>
                </div>
                <button onclick="closeModal('event-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="newEventForm" class="p-6 space-y-5">
                <div>
                    <label for="event-title" class="block text-sm font-semibold text-gray-700 mb-1">Event Title *</label>
                    <input type="text" id="event-title" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="Enter event title">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Event Type *</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button type="button" onclick="selectEventType('Event')" id="type-event" class="type-btn px-4 py-3 rounded-lg border-2 border-blue-600 bg-blue-600 text-white font-medium transition-all">Event</button>
                        <button type="button" onclick="selectEventType('Exam')" id="type-exam" class="type-btn px-4 py-3 rounded-lg border-2 border-gray-200 text-gray-600 hover:border-gray-300 transition-all">Exam</button>
                        <button type="button" onclick="selectEventType('Deadline')" id="type-deadline" class="type-btn px-4 py-3 rounded-lg border-2 border-gray-200 text-gray-600 hover:border-gray-300 transition-all">Deadline</button>
                    </div>
                    <input type="hidden" id="event-type" value="Event">
                </div>

                <div>
                    <label for="event-date-input" class="block text-sm font-semibold text-gray-700 mb-1">Date *</label>
                    <input type="date" id="event-date-input" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                    <input type="hidden" id="event-date" value=""> </div>

                <div class="flex justify-end pt-2 gap-3">
                    <button type="button" onclick="closeModal('event-modal')" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-colors flex items-center gap-1">
                        <i data-lucide="plus" class="w-5 h-5"></i> Add Event
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="task-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Add New Assignment</h3>
                    <p class="text-sm text-gray-500">Create a new assignment with a title, description, and due date</p>
                </div>
                <button onclick="closeModal('task-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="newTaskForm" class="p-6 space-y-5">
                <div>
                    <label for="task-title" class="block text-sm font-semibold text-gray-700 mb-1">Assignment Title *</label>
                    <input type="text" id="task-title" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="Enter assignment title">
                </div>

                <div>
                    <label for="task-description" class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                    <textarea id="task-description" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" rows="3" placeholder="Add assignment details (optional)"></textarea>
                </div>
                
                <div>
                    <label for="task-date-input" class="block text-sm font-semibold text-gray-700 mb-1">Due Date *</label>
                    <input type="date" id="task-date-input" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                    <input type="hidden" id="task-date" value=""> </div>

                <div class="flex justify-end pt-2 gap-3">
                    <button type="button" onclick="closeModal('task-modal')" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center">
                        <i data-lucide="plus" class="w-5 h-5"></i> Publish Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    
    <div id="flashcard-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Create New Flashcard</h3>
                    <p class="text-sm text-gray-500">Add a concept and its definition.</p>
                </div>
                <button onclick="closeModal('flashcard-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="newFlashcardForm" class="p-6 space-y-5">
                <div>
                    <label for="card-front" class="block text-sm font-semibold text-gray-700 mb-1">Concept (Front)</label>
                    <textarea id="card-front" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all" rows="2" placeholder="e.g., Photosynthesis"></textarea>
                </div>

                <div>
                    <label for="card-back" class="block text-sm font-semibold text-gray-700 mb-1">Definition (Back)</label>
                    <textarea id="card-back" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition-all" rows="4" placeholder="e.g., The process by which green plants and some other organisms use sunlight..."></textarea>
                </div>

                <div class="flex justify-end pt-2 gap-3">
                    <button type="button" onclick="closeModal('flashcard-modal')" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" onclick="submitNewFlashcard(event)" class="px-5 py-2.5 bg-orange-600 text-white rounded-lg font-bold shadow-md hover:bg-orange-700 transition-colors flex items-center gap-1">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Create Card
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="submission-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900" id="submission-modal-title">Submit Assignment</h3>
                    <p class="text-sm text-gray-500" id="submission-modal-subtitle">Submitting file for: Loading...</p>
                </div>
                <button onclick="closeModal('submission-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="submissionForm" class="p-6 space-y-5">
                <input type="hidden" id="submission-task-id" value="">
                
                <div class="space-y-2">
                    <label for="submission-file" class="block text-sm font-semibold text-gray-700 mb-1">Select Assignment File *</label>
                    <input type="file" id="submission-file" name="submission_file" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>

                <div class="flex justify-end pt-2 gap-3">
                    <button type="button" onclick="closeModal('submission-modal')" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-colors flex items-center gap-1">
                        <i data-lucide="upload" class="w-5 h-5"></i> Final Submit
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="grade-submission-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Input Grade</h3>
                    <p class="text-sm text-gray-500" id="grade-modal-subtitle">Grading submission: Loading...</p>
                </div>
                <button onclick="closeModal('grade-submission-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="gradeSubmissionForm" onsubmit="submitGrade(event)" class="p-6 space-y-5">
                <input type="hidden" id="grade-submission-id" value="">
                
                <div class="space-y-2">
                    <label for="submission-grade-input" class="block text-sm font-semibold text-gray-700 mb-1">Grade (0-100) *</label>
                    <input type="number" id="submission-grade-input" name="grade" min="0" max="100" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="e.g., 92">
                </div>

                <div class="space-y-2">
                    <label for="teacher-comment-input" class="block text-sm font-semibold text-gray-700 mb-1">Teacher Comment (Optional)</label>
                    <textarea id="teacher-comment-input" rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="Add comments for the student..."></textarea>
                </div>

                <div class="flex justify-end pt-2 gap-3">
                    <button type="button" onclick="closeModal('grade-submission-modal')" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-colors flex items-center gap-1">
                        <i data-lucide="check" class="w-5 h-5"></i> Submit Grade
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-class-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Add New Class</h3>
                    <p class="text-sm text-gray-500">Create a new section for your students.</p>
                </div>
                <button onclick="closeModal('add-class-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="newClassForm" class="p-6 space-y-5">
                <div>
                    <label for="class-name" class="block text-sm font-semibold text-gray-700 mb-1">Class Name *</label>
                    <input type="text" id="class-name" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all" placeholder="e.g., Grade 10 - Physics">
                </div>
                <div>
                    <label for="class-size" class="block text-sm font-semibold text-gray-700 mb-1">Estimated Students</label>
                    <input type="number" id="class-size" value="30" min="5" max="100" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>

                <div class="flex justify-end pt-2 gap-3">
                    <button type="button" onclick="closeModal('add-class-modal')" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-colors flex items-center gap-1">
                        <i data-lucide="plus" class="w-5 h-5"></i> Create Class
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="announcement-post-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Post New Announcement</h3>
                    <p class="text-sm text-gray-500">Share a message with your classes.</p>
                </div>
                <button onclick="closeModal('announcement-post-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="announcement-form-container"></div>
        </div>
    </div>

    <div id="announcement-list-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-3xl h-full md:max-h-[90vh] rounded-xl shadow-2xl overflow-hidden flex flex-col">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center flex-shrink-0">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">All Posted Announcements</h3>
                    <p class="text-sm text-gray-500" id="announcement-list-subtitle">Loading...</p>
                </div>
                <button onclick="closeModal('announcement-list-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="announcement-list-container" class="flex-1 overflow-y-auto divide-y divide-gray-100">
                </div>
        </div>
    </div>
    
    <div id="resource-upload-modal" class="modal hidden-modal fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Upload Class Resource</h3>
                    <p class="text-sm text-gray-500">Share files with your students.</p>
                </div>
                <button onclick="closeModal('resource-upload-modal')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="resourceUploadForm" onsubmit="handleResourceUpload(event)" class="p-6 space-y-5">
                <div class="space-y-2">
                    <label for="resource-upload-file" class="block text-sm font-semibold text-gray-700 mb-1">Select File *</label>
                    <input type="file" id="resource-upload-file" name="resource_file" required class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                </div>
                 <div>
                    <label for="resource-upload-class" class="block text-sm font-semibold text-gray-700 mb-1">Share With</label>
                    <select id="resource-upload-class" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <option value="All Classes">All Classes</option>
                        </select>
                </div>

                <div class="flex justify-end pt-2 gap-3">
                    <button type="button" onclick="closeModal('resource-upload-modal')" class="px-5 py-2.5 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-colors">Cancel</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-colors flex items-center gap-1">
                        <i data-lucide="upload" class="w-5 h-5"></i> Upload Resource
                    </button>
                </div>
            </form>
        </div>
    </div>


    <script>
        // --- CONSTANTS ---
        onst BASE_URL = "https://stuflow-api.onrender.com/api";
		const TODAY = new Date();
		TODAY.setHours(0, 0, 0, 0);
        
        // --- Local Storage Keys (For Client-Only Data) ---
        const JWT_TOKEN_KEY = 'stuflow_jwt_token';
        const STUDY_NOTES_KEY = 'stuflow_study_notes';
        const DARK_MODE_KEY = 'stuflow_dark_mode';
        
        // --- Data Arrays (Loaded from API on Init/Refresh) ---
        let upcomingEvents = []; 
        let currentTasks = []; 
        let classRoster = []; 
        let flashcards = [];
        let teacherAnnouncements = []; 
        let currentSubmissions = []; // Stores submissions for teacher view
        let sharedResources = []; // NEW: Stores shared class resources

        // --- Dynamic State ---
        let currentMockUser = null;
	let currentCardIndex = 0;
	let isFrontSide = true;
	let currentStudyTool = 'pomodoro';
	let lastActiveSection = 'dashboard';
	let currentCalendarDate = new Date(); // CHANGED: Use current date instead of fixed date
	let currentEmail = ""; // Store email for verification
        
        // --- Auth & Data Functions ---

        // Helper to get Auth Headers (For JSON bodies)
        const getAuthHeaders = () => ({
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem(JWT_TOKEN_KEY)}`
        });
        
        // NEW HELPER: For file uploads (must omit 'Content-Type: application/json')
        const getFileAuthHeaders = () => ({
            'Authorization': `Bearer ${localStorage.getItem(JWT_TOKEN_KEY)}`
        });


        // Fetch User Profile from API
        const fetchUserProfile = async () => {
            const token = localStorage.getItem(JWT_TOKEN_KEY);
            if (!token) return null;
            
            try {
                const response = await fetch(`${BASE_URL}/user/me`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    currentMockUser = await response.json();
                    return currentMockUser;
                } else {
                    localStorage.removeItem(JWT_TOKEN_KEY);
                    return null;
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                return null;
            }
        };

        // Fetch Core Data from API (UPDATED to remove document fetching)
        const fetchCoreData = async () => {
             try {
                // Fetch general user data concurrently (REMOVED: foldersRes)
                const [tasksRes, eventsRes, flashcardsRes, resourcesRes] = await Promise.all([
                    fetch(`${BASE_URL}/tasks`, { headers: getAuthHeaders() }),
                    fetch(`${BASE_URL}/events`, { headers: getAuthHeaders() }),
                    fetch(`${BASE_URL}/flashcards`, { headers: getAuthHeaders() }),
                    fetch(`${BASE_URL}/resources`, { headers: getAuthHeaders() }) 
                ]);
                
                // Update global arrays (filled by API data)
                if (tasksRes.ok) currentTasks = await tasksRes.json();
                if (eventsRes.ok) upcomingEvents = await eventsRes.json();
                
                // REMOVED: documentFolders fetching logic
                
                if (flashcardsRes.ok) flashcards = await flashcardsRes.json();
                if (resourcesRes.ok) sharedResources = await resourcesRes.json(); // NEW
                
                // Teacher-specific data
                if (currentMockUser.role === 'teacher') {
                     const [classesRes, announcementsRes, submissionsRes] = await Promise.all([
                         fetch(`${BASE_URL}/classes`, { headers: getAuthHeaders() }),
                         fetch(`${BASE_URL}/announcements`, { headers: getAuthHeaders() }), 
                         fetch(`${BASE_URL}/submissions`, { headers: getAuthHeaders() }) 
                     ]);
                     if (classesRes.ok) classRoster = await classesRes.json();
                     if (announcementsRes.ok) teacherAnnouncements = await announcementsRes.json();
                     if (submissionsRes.ok) currentSubmissions = await submissionsRes.json();
                } else {
                    // Student: fetch announcements
                    const announcementsRes = await fetch(`${BASE_URL}/announcements`, { headers: getAuthHeaders() });
                    if (announcementsRes.ok) teacherAnnouncements = await announcementsRes.json();
                }

            } catch (error) {
                console.error('Error fetching core data:', error);
                // If core data fails, user may be logged out or network is down
            }
        };

        // --- DOM Elements ---
        const views = {
            loading: document.getElementById('view-loading'),
            auth: document.getElementById('view-auth'),
            verification: document.getElementById('view-verification'),
            dashboard: document.getElementById('view-dashboard')
        };
        const otpInputs = document.querySelectorAll('.otp-input');
        const mainContent = document.querySelector('main'); 

        // --- Utility Functions ---
        
        window.switchAuth = (type) => {
            const loginForm = document.getElementById('form-login');
            const signupForm = document.getElementById('form-signup');
            if (type === 'signup') {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
                signupForm.classList.add('fade-in');
            } else {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                loginForm.classList.add('fade-in');
            }
        };

        window.selectRole = (role) => {
            document.getElementById('signup-role').value = role;
            const sBtn = document.getElementById('role-student');
            const tBtn = document.getElementById('role-teacher');
            
            if (role === 'student') {
                sBtn.className = "cursor-pointer p-3 rounded-lg border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold text-center transition-all";
                tBtn.className = "cursor-pointer p-3 rounded-lg border-2 border-gray-200 text-gray-500 hover:border-gray-300 text-center transition-all";
            } else {
                tBtn.className = "cursor-pointer p-3 rounded-lg border-2 border-blue-600 bg-blue-50 text-blue-700 font-bold text-center transition-all";
                sBtn.className = "cursor-pointer p-3 rounded-lg border-2 border-gray-200 text-gray-500 hover:border-gray-300 text-center transition-all";
            }
        };

        window.showToast = (message, type = 'info') => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            const colors = {
                success: 'bg-blue-100 text-blue-800 border-blue-200', // CONVERTED FROM GREEN
                error: 'bg-red-100 text-red-800 border-red-200',
                info: 'bg-white text-gray-800 border-gray-200 shadow-lg'
            };
            const darkColors = {
                 success: 'bg-blue-700 text-white border-blue-600 shadow-md', // CONVERTED FROM GREEN
                 error: 'bg-red-700 text-white border-red-600 shadow-md',
                 info: 'bg-gray-600 text-white border-gray-500 shadow-md'
            };
            
            const selectedColor = document.body.classList.contains('dark') ? darkColors[type] : colors[type];


            toast.className = `p-4 rounded-lg border flex items-center gap-3 min-w-[300px] toast-enter ${selectedColor}`;
            toast.innerHTML = `
                <span class="font-medium flex-1">${message.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>')}</span>
                <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-200">✕</button>
            `;
            
            container.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('toast-enter');
                toast.classList.add('toast-enter-active');
            });

            setTimeout(() => {
                toast.classList.remove('toast-enter-active');
                toast.classList.add('toast-exit-active');
                setTimeout(() => toast.remove(), 300);
            }, 6000);
        };

        function switchView(viewName) {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewName].classList.remove('hidden');
            if (viewName === 'dashboard' || viewName === 'verification') {
                requestAnimationFrame(() => lucide.createIcons());
            }
        }
        
        // --- Modal Functions ---
        window.openModal = (id) => {
    const modal = document.getElementById(id);
			if (modal) {
				modal.classList.remove('hidden-modal');
				modal.classList.add('active-modal');
        
				const today = new Date();
				const localISODate = new Date(today.getTime() - today.getTimezoneOffset() * 60000)
				.toISOString()
				.split('T')[0];
				document.getElementById('task-date-input').value = localISODate;


			if (id === 'task-modal') {
				document.getElementById('task-date-input').value = today;
				document.getElementById('task-date-input').min = today; // Prevent past dates
				lucide.createIcons();
        }
			if (id === 'event-modal') {
				document.getElementById('event-date-input').value = today;
				document.getElementById('event-date-input').min = today; // Prevent past dates
				selectEventType('Event'); // Reset type selection
				lucide.createIcons();
        }
                // REMOVED: if (id === 'upload-document-modal') 
                if (id === 'announcement-post-modal') { 
                     renderAnnouncementForm();
                     lucide.createIcons();
                }
                if (id === 'resource-upload-modal') { // NEW MODAL
                     renderResourceUploadOptions();
                     lucide.createIcons();
                }

                // FIX: Defer icon creation for this list modal to prioritize visual appearance
                if (id === 'announcement-list-modal') {
                     // Defer icon creation until AFTER the modal's visibility change is complete.
                     setTimeout(() => {
                         lucide.createIcons();
                     }, 50); 
                }
                
                // For modals not explicitly handled above (e.g., flashcard-modal), run icons immediately
                if (id !== 'announcement-list-modal') {
                    lucide.createIcons();
                }
            }
        };
        
        // NEW: Populate class options for resource upload
        function renderResourceUploadOptions() {
             const select = document.getElementById('resource-upload-class');
             // Clear existing options, but keep "All Classes"
             select.innerHTML = '<option value="All Classes">All Classes</option>';
             
             classRoster.forEach(c => {
                 const option = document.createElement('option');
                 option.value = c.name;
                 option.innerText = c.name;
                 select.appendChild(option);
             });
        }

        window.closeModal = (id) => {
            const modal = document.getElementById(id);
            if (modal) {
                modal.classList.remove('active-modal');
                modal.classList.add('hidden-modal');
            }
        };

        window.selectEventType = (type) => {
            document.getElementById('event-type').value = type;
            document.querySelectorAll('.type-btn').forEach(btn => {
                if (btn.innerText === type) {
                    btn.className = "type-btn px-4 py-3 rounded-lg border-2 border-blue-600 bg-blue-600 text-white font-medium transition-all";
                } else {
                    btn.className = "type-btn px-4 py-3 rounded-lg border-2 border-gray-200 text-gray-600 hover:border-gray-300 text-center transition-all";
                }
            });
        };
        
        // --- NEW: Submission Modal Logic ---
        window.openSubmissionModal = (taskId, taskTitle) => {
            document.getElementById('submission-modal-subtitle').innerText = `Submitting file for: ${taskTitle}`;
            document.getElementById('submission-task-id').value = taskId;
            openModal('submission-modal');
        }

        window.submitAssignment = async (e) => {
            e.preventDefault();
            
            const taskId = document.getElementById('submission-task-id').value;
            const fileInput = document.getElementById('submission-file'); 
            
            if (fileInput.files.length === 0) {
                window.showToast('Please select a file to upload.', 'error');
                return;
            }
            
            // Use FormData to correctly handle multipart/form-data encoding
            const formData = new FormData();
            formData.append('submission_file', fileInput.files[0]); 
            
            try {
                const response = await fetch(`${BASE_URL}/submissions/${taskId}/submit`, {
                    method: 'POST',
                    // IMPORTANT: Use the file-compatible headers (no explicit Content-Type: application/json)
                    headers: getFileAuthHeaders(), 
                    body: formData // Send the FormData object
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('submissionForm').reset();
                    closeModal('submission-modal');
                    
                    await fetchCoreData(); 
                    loadAssignmentsContent(); 
                    loadDashboardContent(currentMockUser); 
                    window.showToast(data.message, 'success');
                } else {
                     window.showToast(`Submission Error: ${data.message}`, 'error');
                }
            } catch (error) {
                window.showToast('Network error while submitting assignment.', 'error');
            }
        }
        
        // New function to handle grade submission
        window.submitGrade = async (e) => {
            e.preventDefault();
            
            const submissionId = document.getElementById('grade-submission-id').value;
            const grade = parseInt(document.getElementById('submission-grade-input').value, 10); 
            const teacherComment = document.getElementById('teacher-comment-input').value.trim(); // NEW: Get comment
            
            if (isNaN(grade) || grade < 0 || grade > 100) {
                window.showToast('Please enter a valid grade between 0 and 100.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${BASE_URL}/submissions/${submissionId}/grade`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ 
                        grade: grade,
                        teacher_comment: teacherComment // NEW: Send comment
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('gradeSubmissionForm').reset();
                    closeModal('grade-submission-modal');
                    
                    await fetchCoreData(); 
                    loadSubmissionsContent(); // Refresh submissions list
                    loadDashboardContent(currentMockUser); // Refresh dashboard stats
                    window.showToast(`Submission successfully graded at ${grade}%.`, 'success');
                } else {
                     window.showToast(`Grading Error: ${data.message}`, 'error');
                }
            } catch (error) {
                window.showToast('Network error while submitting grade.', 'error');
            }
        }


        // --- Logic: Verification ---
        
        async function resendVerificationCode() {
            try {
                const response = await fetch(`${BASE_URL}/verify/resend`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail })
                });

                const data = await response.json();

                if (response.ok) {
                    window.showToast('New verification code sent!', 'success');
                    otpInputs.forEach(input => input.value = '');
                    otpInputs[0].focus();
                } else {
                    window.showToast(data.message, 'error');
                }
            } catch (error) {
                window.showToast('Network error while resending code.', 'error');
            }
        }

        function setupOtpInputs() {
            otpInputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if (e.key >= 0 && e.key <= 9) {
                        input.value = '';
                        setTimeout(() => {
                            if(index < otpInputs.length - 1) otpInputs[index + 1].focus();
                        }, 10);
                    } else if (e.key === 'Backspace') {
                        if (input.value === '' && index > 0) otpInputs[index - 1].focus();
                    }
                });
                
                input.addEventListener('input', () => {
                    checkVerification();
                });
            });
        }

        async function checkVerification() {
            const code = Array.from(otpInputs).map(i => i.value).join('');
            if (code.length === 6) {
                await verifyWithBackend(code);
            }
        }

        async function verifyWithBackend(code) {
            try {
                const response = await fetch(`${BASE_URL}/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, code })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem(JWT_TOKEN_KEY, data.token);
                    window.showToast('Verification Successful!', 'success');
                    loadDashboard();
                } else {
                    window.showToast(data.message, 'error');
                    otpInputs.forEach(i => { 
                        i.value = ''; 
                        i.classList.add('border-red-500'); 
                    });
                    setTimeout(() => otpInputs.forEach(i => i.classList.remove('border-red-500')), 1000);
                }
            } catch (error) {
                window.showToast('Network error during verification.', 'error');
            }
        }
        
        // --- Logic: Dashboard Render Helpers ---
        function createStatCard(title, value, icon, colorClass, iconColorClass, onClickAction = '') {
            return `
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-start hover:shadow-md transition-shadow min-h-[110px] ${onClickAction ? 'cursor-pointer' : ''}" onclick="${onClickAction}">
                <div class="flex items-start justify-between mb-2">
                    <h3 class="text-2xl font-bold text-gray-800 leading-none">${value}</h3>
                    <div class="p-2 rounded-lg w-fit ${iconColorClass} text-white">
                        <i data-lucide="${icon}" class="w-6 h-6 ${colorClass}"></i>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-auto">${title}</p>
            </div>`;
        }
        
        function createQuickAccessLink(title, icon, iconColorClass, bgColorClass, onClickAction) {
            return `
            <button onclick="${onClickAction}" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                <div class="p-2 rounded-lg ${bgColorClass} w-fit">
                    <i data-lucide="${icon}" class="w-5 h-5 ${iconColorClass}"></i>
                </div>
                <p class="text-sm font-medium text-gray-800">${title}</p>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 ml-auto"></i>
            </button>`;
        }

        function createTeacherStatCardNew(title, value, icon, iconColorClass, bgColorClass) {
            return `
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-start hover:shadow-md transition-shadow min-h-[110px]">
                <div class="flex items-start justify-between mb-2">
                    <h3 class="text-2xl font-bold text-gray-800 leading-none">${value}</h3>
                    <div class="p-2 rounded-lg w-fit ${iconColorClass} text-white">
                        <i data-lucide="${icon}" class="w-6 h-6 ${iconColorClass}"></i>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-auto">${title}</p>
            </div>`;
        }
        
        function createTeacherQuickAccessLink(title, icon, iconColorClass, bgColorClass, onClickAction) {
            return `
            <button onclick="${onClickAction}" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-gray-50 transition-colors text-left">
                <div class="p-2 rounded-lg ${bgColorClass} w-fit">
                    <i data-lucide="${icon}" class="w-5 h-5 ${iconColorClass}"></i>
                </div>
                <p class="text-sm font-medium text-gray-800">${title}</p>
                <i data-lucide="chevron-right" class="w-4 h-4 text-gray-400 ml-auto"></i>
            </button>`;
        }
        
        function createTeacherSubmissionItem(item) {
            // item is now from /api/submissions
            const isGraded = item.status === 'Graded';
            const statusText = isGraded ? `Graded: ${item.grade}%` : 'Pending Grade';
            const statusColor = isGraded ? 'bg-blue-100 text-blue-600' : 'bg-red-100 text-red-600'; // CONVERTED FROM GREEN
            
            // NEW: Logic for the action button
            const actionButton = !isGraded ? `
                 <button onclick="handleGradeAction(${item.id}, '${item.student_name} - ${item.assignment_title}')" class="text-blue-600 hover:text-blue-700 text-sm font-semibold flex items-center gap-1">
                    <i data-lucide="edit" class="w-4 h-4"></i> Grade
                 </button>
            ` : `
                 <span class="text-sm text-blue-600 font-medium">Final Grade: ${item.grade}%</span> `;
            
            // NEW: Display Comment if present
            const commentDisplay = item.teacher_comment ? `
                <div class="w-full text-left pt-2 border-t border-gray-100 mt-2">
                    <p class="text-xs font-semibold text-gray-700">Comment:</p>
                    <p class="text-xs text-gray-600 italic max-w-xs truncate">${item.teacher_comment}</p>
                </div>
            ` : '';
            
            return `
                <div id="submission-item-${item.id}" class="p-4 flex items-start justify-between hover:bg-gray-50 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="p-2 rounded-lg bg-gray-100 text-gray-600">
                            <i data-lucide="file-text" class="w-4 h-4"></i>
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 text-sm">${item.student_name} - ${item.assignment_title}</p>
                            <p class="text-xs text-gray-500">File: ${item.submitted_file} | Due: ${formatDate(item.due_date)}</p>
                            ${commentDisplay} </div>
                    </div>
                    <div class="text-right flex items-center gap-4">
                         <span class="text-xs px-3 py-1 rounded-full font-bold ${statusColor}">
                            ${statusText}
                         </span>
                         <button class="text-orange-600 hover:text-orange-700 text-sm font-semibold flex items-center gap-1">
                            <i data-lucide="download" class="w-4 h-4"></i> Download
                         </button>
                         ${actionButton}
                    </div>
                </div>
            `;
        }

        window.handleGradeAction = (submissionId, itemTitle) => {
            // Updated to open the grade input modal
            document.getElementById('grade-modal-subtitle').innerText = `Grading submission: ${itemTitle}`;
            document.getElementById('grade-submission-id').value = submissionId;
            document.getElementById('submission-grade-input').value = ''; // Clear previous input
            document.getElementById('teacher-comment-input').value = ''; // NEW: Clear comment input
            openModal('grade-submission-modal');
        }

        function formatDate(dateString) {
            if (!dateString) return 'No Due Date';
            try {
                const date = new Date(dateString + 'T00:00:00'); 
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            } catch (e) {
                return dateString;
            }
        }
        
        function isUrgent(dueDateString) {
            if (!dueDateString) return false;
            
            const today = TODAY; 
            today.setHours(0, 0, 0, 0);

            const dueDate = new Date(dueDateString + 'T00:00:00');
            dueDate.setHours(0, 0, 0, 0);

            const oneDay = 24 * 60 * 60 * 1000;
            const diffDays = Math.round((dueDate.getTime() - today.getTime()) / oneDay);
            
            return diffDays <= 1 && diffDays >= 0;
        }

        function getTaskDisplayStatus(task) {
             let displayStatus = task.status;
             
             // Check for grading status first
             if (task.status.startsWith('Graded:')) {
                 return 'Graded';
             }
             
             if (task.status !== 'Completed' && isUrgent(task.due)) {
                 displayStatus = 'Urgent';
             }
             return displayStatus;
        }

        function createTaskItem(task) {
            const displayStatus = getTaskDisplayStatus(task);
            
            // NEW: Check if the status explicitly contains "Graded" (from backend update)
            const isGraded = task.status.startsWith('Graded:');

            let statusColor = 'text-blue-600 bg-blue-50 border-blue-200';
            if (isGraded) statusColor = 'text-blue-600 bg-blue-50 border-blue-200'; // CONVERTED FROM GREEN
            else if (displayStatus === 'Urgent') statusColor = 'text-red-600 bg-red-50 border-red-200';
            else if (task.status === 'Completed') statusColor = 'text-gray-600 bg-gray-50 border-gray-200'; // Submitted/Completed but ungraded
            
            let actionButton;
            let statusText = task.status; // Default status text
            const teacherComment = task.teacher_comment; // NEW: Get comment from task object

            // Logic for Student Role
            if (currentMockUser.role === 'student') {
                if (isGraded) {
                     actionButton = `
                         <span class="text-sm text-blue-600 font-bold flex items-center gap-1">
                             <i data-lucide="award" class="w-4 h-4"></i> Final Grade
                         </span>
                    `; // CONVERTED FROM GREEN
                    // Clean up status text for display, e.g., "Graded: 92%" -> "Final Grade: 92%"
                    statusText = task.status.replace('Graded:', 'Final Grade: '); 
                } else if (task.status === 'Completed') {
                    actionButton = `
                        <span class="text-sm text-gray-500 font-medium flex items-center gap-1">
                            <i data-lucide="check-check" class="w-4 h-4"></i> Submitted (Pending Grade)
                        </span>
                    `;
                    statusText = 'Submitted';
                } else {
                    actionButton = `
                        <button onclick="openSubmissionModal(${task.id}, '${task.title}')" class="flex items-center gap-1 text-sm text-blue-600 font-medium hover:text-blue-700">
                            <i data-lucide="upload" class="w-4 h-4"></i> Submit File
                        </button>
                    `;
                    statusText = displayStatus;
                }
            } else {
                // Logic for Teacher Role: No action button needed on their master task list
                actionButton = `
                    <span class="text-sm text-gray-500 font-medium flex items-center gap-1">
                        <i data-lucide="info" class="w-4 h-4"></i> Master Task
                    </span>
                `;
            }
            
            // NEW: Comment box for student to see
            const commentBox = (isGraded && teacherComment) ? `
                <div class="w-full mt-3 p-3 rounded-lg bg-gray-50 border border-gray-200">
                     <p class="text-xs font-semibold text-gray-700 mb-1 flex items-center gap-1">
                         <i data-lucide="message-square" class="w-4 h-4"></i> Teacher Comments
                     </p>
                     <p class="text-sm text-gray-700 italic">${teacherComment}</p>
                </div>
            ` : '';
            
            const urgentClass = !isGraded && displayStatus === 'Urgent' ? 'bg-red-50' : 'bg-white';
            
            return `
                <div id="task-${task.id}" class="${urgentClass} p-6 rounded-xl shadow-md border border-gray-100 space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-900 text-lg">${task.title}</p>
                            <p class="text-sm text-gray-500 mt-1">${task.description}</p>
                        </div>
                        <span class="flex items-center gap-1 text-xs px-2 py-1 rounded-lg border font-medium ${statusColor}">
                            <i data-lucide="clock" class="w-3 h-3"></i> ${statusText}
                        </span>
                    </div>
                    ${commentBox}
                    <div class="border-t border-gray-100 pt-3 flex justify-between items-center">
                        <span class="flex items-center gap-2 text-sm text-gray-600">
                            <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i> Due: ${formatDate(task.due)}
                        </span>
                        ${actionButton}
                    </div>
                </div>
            `;
        }
        
        window.markTaskDone = async (id, title) => {
             // This is mostly deprecated for students but kept for completeness on the PUT endpoint (non-assignment tasks)
             try {
                const response = await fetch(`${BASE_URL}/tasks/${id}/complete`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                });
                
                if (response.ok) {
                    await fetchCoreData(); // Re-fetch data
                    loadAssignmentsContent(); 
                    loadDashboardContent(currentMockUser); 
                    window.showToast(`Assignment '${title}' marked as completed!`, 'success');
                } else {
                     window.showToast(`Error: ${await response.json().message}`, 'error');
                }
            } catch (error) {
                window.showToast('Network error while marking task as done.', 'error');
            }
        }
        
        function renderTasksList(filter = 'Ongoing') {
    const container = document.getElementById('tasks-list');
    
    const filteredTasks = currentTasks.filter(task => {
        const displayStatus = getTaskDisplayStatus(task);
        
        // If Graded, show in Completed tab
        if (displayStatus === 'Graded') return filter === 'Completed';

        if (filter === 'Ongoing') {
            // Show both Ongoing AND Urgent tasks in the Ongoing tab
            return displayStatus === 'Ongoing' || displayStatus === 'Urgent';
        }
        if (filter === 'Urgent') {
            // Only show Urgent tasks in Urgent tab
            return displayStatus === 'Urgent'; 
        }
        if (filter === 'Completed') {
            // Show completed or graded tasks
            return task.status === 'Completed' || displayStatus === 'Graded';
        }
        return true; 
    });
    
    const tasksToRender = filteredTasks; 

    if (tasksToRender.length === 0) {
        container.innerHTML = `
            <div class="p-10 bg-white rounded-xl shadow-sm border border-gray-100 text-center mt-6">
                <i data-lucide="clipboard-check" class="w-12 h-12 mx-auto text-blue-400 mb-4"></i> <h3 class="font-bold text-gray-800 text-lg">All caught up!</h3>
                <p class="text-gray-500">No assignments found in the '${filter}' category. Check back later.</p>
            </div>
        `;
    } else {
         container.innerHTML = tasksToRender.map(createTaskItem).join('');
    }
    lucide.createIcons();
}

        window.selectTaskFilter = (filter) => {
            document.querySelectorAll('.task-filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm', 'font-bold');
                btn.classList.add('text-gray-500', 'hover:bg-gray-50');
            });
            
            const selectedBtn = document.getElementById(`filter-${filter}`);
            selectedBtn.classList.remove('text-gray-500', 'hover:bg-gray-50');
            selectedBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm', 'font-bold');
            
            document.getElementById('task-filter-active').value = filter;
            
            renderTasksList(filter);
        };
        
        // --- Task Modal Form Submission Logic ---
        
        window.submitNewTask = async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('task-title').value.trim();
            const description = document.getElementById('task-description').value.trim() || 'No description provided.';
            const dueDate = document.getElementById('task-date-input').value; 

            if (!title || !dueDate) {
                window.showToast('Please enter an assignment title and due date.', 'error');
                return;
            }

            // Since only teachers can use this endpoint now, we don't need the role check here.
            
            const newTaskPayload = {
                title: title,
                description: description,
                due: dueDate, 
            };
            
            try {
                const response = await fetch(`${BASE_URL}/tasks`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(newTaskPayload)
                });
                
                const data = await response.json();

                if (response.ok) {
                    // Reset and close modal
                    document.getElementById('newTaskForm').reset();
                    closeModal('task-modal');
                    
					currentCalendarDate = new Date(dueDate); // ✅ update to the new task’s due date

                    await fetchCoreData(); // Re-fetch all data to include the new task
                    loadDashboardContent(currentMockUser); 
                    loadContent(lastActiveSection); 
                    
                    window.showToast(data.message, 'success');
                } else {
                    window.showToast(`Error: ${data.message}`, 'error');
                }
            } catch (error) {
                 window.showToast('Network error while publishing assignment.', 'error');
            }
        }

        // --- Schedule List Render Function ---

        function renderScheduleList() {
            const eventListContainer = document.getElementById('upcoming-event-list');
            if (!eventListContainer) return;

            if (upcomingEvents.length === 0) {
                 eventListContainer.innerHTML = `
                    <div class="p-6 bg-white rounded-xl shadow-sm border border-gray-100 text-center">
                        <i data-lucide="calendar-check" class="w-10 h-10 mx-auto text-gray-400 mb-3"></i>
                        <p class="font-semibold text-gray-800">Your schedule is clear.</p>
                        <p class="text-sm text-gray-500">Click 'Add Event' to plan your next deadline or exam.</p>
                    </div>
                `;
            } else {
                 eventListContainer.innerHTML = upcomingEvents
                    .sort((a, b) => new Date(a.date) - new Date(b.date)) 
                    .map(e => createScheduleEventItem(e.title, e.date, e.type))
                    .join('');
            }
            lucide.createIcons();
        }
        
        // REWRITTEN TO USE LIVE DATA (REMOVED: documentFolders from signature, logic handled inside)
        function generateDashboardStats(tasks, events, folders, classes) {
            const today = TODAY; 
            const oneDay = 24 * 60 * 60 * 1000;
            const oneWeek = 7 * oneDay;

            // 1. Tasks Due Today
            const tasksDueTodayCount = tasks.filter(task => {
                if (task.status.startsWith('Graded:')) return false; // Graded tasks are complete
                if (task.status === 'Completed') return false;
                if (!task.due) return false;
                const taskDate = new Date(task.due + 'T00:00:00');
                return taskDate.getTime() === today.getTime();
            }).length;

            // 2. Upcoming Exams (In the next 7 days)
            const upcomingExams = events.filter(event => {
                if (event.type !== 'Exam') return false;
                const eventDate = new Date(event.date + 'T00:00:00');
                const timeDiff = eventDate.getTime() - today.getTime();
                return timeDiff >= 0 && timeDiff <= oneWeek;
            });
            const upcomingExamsCount = upcomingExams.length;


            // REMOVED: 3. Documents Uploaded (Dynamic Count)
            const documentsUploadedCount = sharedResources.length; // Uses sharedResources count
            
            // 4. Urgent Tasks (Due Today or Tomorrow)
            const urgentTasks = tasks.filter(task => 
                !task.status.startsWith('Graded:') && task.status !== 'Completed' && isUrgent(task.due)
            ).sort((a, b) => new Date(a.due) - new Date(b.due));

            // 5. Events in Next 7 Days 
            const upcomingEventsNextWeek = events.filter(event => {
                const isUrgentExam = event.type === 'Exam' && upcomingExams.some(e => e.title === event.title && e.date === event.date);
                if (isUrgentExam) return false; 
                
                const eventDate = new Date(event.date + 'T00:00:00');
                const timeDiff = eventDate.getTime() - today.getTime();
                return timeDiff >= 0 && timeDiff <= oneWeek; 
            }).sort((a, b) => new Date(a.date) - new Date(b.date));


            return {
                tasksDueToday: tasksDueTodayCount,
                upcomingExams: upcomingExamsCount,
                documentsUploaded: documentsUploadedCount, // Now uses sharedResources count
                urgentTasks: urgentTasks,
                upcomingEventsNextWeek: upcomingEventsNextWeek,
                // Teacher specific metrics added below:
                activeClasses: classes.length,
                totalStudents: classes.reduce((sum, cls) => sum + cls.estimated_students, 0),
                pendingSubmissions: currentSubmissions.filter(s => s.status === 'Submitted').length, 
            };
        }
        
        // --- Event Adding Function (Called by Modal Form Submission) ---
        window.submitNewEvent = async (e) => {
    e.preventDefault();
    
    const title = document.getElementById('event-title').value.trim();
    const date = document.getElementById('event-date-input').value;
    const type = document.getElementById('event-type').value;

    if (!title || !date) {
        window.showToast('Please enter an event title and select a date.', 'error');
        return;
    }
    
    const newEventPayload = {
        title: title,
        date: date,
        type: type,
    };
    
    try {
        const response = await fetch(`${BASE_URL}/events`, {
            method: 'POST',
            headers: getAuthHeaders(),
            body: JSON.stringify(newEventPayload)
        });
        
        if (response.ok) {
            closeModal('event-modal');
            
            await fetchCoreData(); // Re-fetch events
            
            // FIX: Update calendar to the new event date
			currentCalendarDate = new Date(date);

            
            loadDashboardContent(currentMockUser);
            loadContent(lastActiveSection);
            
            document.getElementById('newEventForm').reset();
            selectEventType('Event');
            window.showToast(`Added new ${type}: ${title} on ${formatDate(date)}`, 'success');

        } else {
            window.showToast(`Error: ${await response.json().message}`, 'error');
        }
    } catch (error) {
         window.showToast('Network error while adding event.', 'error');
    }
}

        // Schedule Event Item Helper
        function createScheduleEventItem(title, date, type) {
            let color = 'bg-blue-500';
            let icon = 'calendar';
            let borderColor = 'border-blue-500';

            if (type === 'Exam') {
                color = 'bg-red-500';
                icon = 'book-open-check';
                borderColor = 'border-red-500';
            }
            if (type === 'Deadline') {
                color = 'bg-orange-500';
                icon = 'alert-triangle';
                borderColor = 'border-orange-500';
            }

            return `
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 ${borderColor} flex items-center justify-between transition-colors fade-in">
                    <div class="flex items-center gap-4">
                        <i data-lucide="${icon}" class="w-5 h-5 text-gray-400"></i>
                        <div>
                            <p class="font-semibold text-gray-800">${title}</p>
                            <p class="text-xs text-gray-500">${formatDate(date)}</p>
                        </div>
                    </div>
                    <span class="text-xs px-3 py-1 rounded-full font-bold text-white ${color}">${type}</span>
                </div>
            `;
        }
        
        // --- Document Page Helpers ---
        
        // --- Assignment Page Logic ---
        function loadAssignmentsContent() {
            const activeFilter = document.getElementById('task-filter-active')?.value || 'Ongoing';
            
            // Hide 'Add Assignment' button for students
            const addAssignmentButton = currentMockUser.role === 'teacher' ? `
                <button class="w-full py-4 mb-8 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center gap-2"
                    onclick="openModal('task-modal')">
                    <i data-lucide="plus" class="w-5 h-5"></i> Add Assignment
                </button>
            ` : '';

            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <div class="flex items-center gap-3">
                        <i data-lucide="file-text" class="w-7 h-7 text-blue-600"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Assignments & Deadlines</h1>
                            <p class="text-gray-500 text-sm">Your Academic Timeline</p>
                        </div>
                    </div>
                </div>
                
                <div class="max-w-xl mx-auto">
                    ${addAssignmentButton}
                    
                    <div class="flex bg-gray-100 p-1 rounded-xl mb-6 shadow-inner">
                        <button id="filter-Ongoing" onclick="selectTaskFilter('Ongoing')" class="task-filter-btn flex-1 py-2 rounded-lg transition-all text-sm font-medium">Ongoing</button>
                        <button id="filter-Urgent" onclick="selectTaskFilter('Urgent')" class="task-filter-btn flex-1 py-2 rounded-lg transition-all text-sm font-medium">Urgent</button>
                        <button id="filter-Completed" onclick="selectTaskFilter('Completed')" class="task-filter-btn flex-1 py-2 rounded-lg transition-all text-sm font-medium">Completed</button>
                    </div>
                    
                    <input type="hidden" id="task-filter-active" value="${activeFilter}">

                    <div id="tasks-list" class="space-y-4">
                        </div>
                </div>
            `;
            
            selectTaskFilter(activeFilter);
        }
        
        function calculateCompletionRate() {
            const completedCount = currentTasks.filter(t => t.status.startsWith('Graded:') || t.status === 'Completed').length;
            const totalCount = currentTasks.length;
            const rate = totalCount === 0 ? 0 : Math.round((completedCount / totalCount) * 100);
            return { completed: completedCount, total: totalCount, rate: rate };
        }

        function renderUrgentTasksCard(urgentTasks) {
            const taskListHTML = urgentTasks.length > 0 ? urgentTasks.map(task => `
                <div class="flex items-center gap-3 p-3 rounded-lg border border-red-200 bg-red-50">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600 flex-shrink-0"></i>
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800 text-sm truncate">${task.title}</p>
                        <p class="text-xs text-gray-500">Due: ${formatDate(task.due)}</p>
                    </div>
                </div>
            `).join('') : `
                <div class="p-8 text-center text-gray-500">
                    <i data-lucide="check-circle" class="w-8 h-8 mx-auto text-blue-500 mb-2"></i> <p class="font-medium">No urgent assignments due today or tomorrow! Start a new assignment.</p>
                </div>
            `;

            return `
                <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-900">🔥 Urgent Assignments & Deadlines</h3>
                    </div>
                    <div class="p-4 space-y-3">
                        ${taskListHTML}
                    </div>
                    <div class="p-4 border-t border-gray-100">
                        <button onclick="loadContent('assignments')" class="text-sm font-semibold text-blue-600 hover:text-blue-700 w-full text-center">
                            View All Assignments
                        </button>
                    </div>
                </div>
            `;
        }

        function renderUpcomingEventsCard(upcomingEvents) {
            // Filter out undefined events and ensure we have valid data
            const validEvents = upcomingEvents.filter(e => e && e.title && e.date);
            
            const eventListHTML = validEvents.slice(0, 5).map(e => {
                let color = 'border-blue-500';
                let icon = 'calendar';
                if (e.type === 'Exam') {
                    color = 'border-red-500';
                    icon = 'book-open-check';
                }
                if (e.type === 'Deadline') {
                    color = 'border-orange-500';
                    icon = 'alert-triangle';
                }

                return `
                    <div class="flex items-center gap-3 border-l-4 ${color} pl-3 py-1">
                        <i data-lucide="${icon}" class="w-4 h-4 text-gray-400"></i>
                        <div>
                            <p class="font-medium text-gray-800 text-sm truncate">${e.title}</p>
                            <p class="text-xs text-gray-500">${formatDate(e.date)} - ${e.type}</p>
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-900">🗓️ Upcoming Schedule (7 Days)</h3>
                    </div>
                    <div class="p-4 space-y-4">
                        ${eventListHTML.length > 0 ? eventListHTML : '<p class="p-4 text-center text-gray-500 text-sm">No scheduled events next week. Add an event to your calendar.</p>'}
                    </div>
                    <div class="p-4 border-t border-gray-100">
                         <button onclick="openModal('event-modal')" class="flex items-center justify-center gap-1 text-sm font-bold text-blue-600 hover:text-blue-700 w-full">
                            <i data-lucide="plus" class="w-4 h-4"></i> Add New Event
                        </button>
                    </div>
                </div>
            `;
        }
        
        // UPDATED: Removed My Documents quick link
        function renderQuickLinksCard() {
            return `
                 <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900">🔗 Quick Access</h3>
                    </div>
                    <div class="p-2 space-y-1">
                        ${createQuickAccessLink('Shared Resources', 'folder-open', 'text-blue-600', 'bg-blue-100', "loadContent('resources')")} ${createQuickAccessLink('Study Tools', 'brain-circuit', 'text-blue-600', 'bg-blue-100', "loadContent('study-tools')")} ${createQuickAccessLink('View Announcements', 'megaphone', 'text-blue-600', 'bg-blue-100', "renderStudentAnnouncementList()")}
                    </div>
                </div>
            `;
        }
        
        // --- Schedule Calendar Render Logic ---
        
        function getCalendarDatesHTML(currentDate, events) {
    const currentYear = currentDate.getFullYear();
    const currentMonth = currentDate.getMonth();
    
    const eventsByDate = {};
    events.forEach(e => {
        const eventDate = new Date(e.date + 'T00:00:00');
        if (eventDate.getMonth() === currentMonth && eventDate.getFullYear() === currentYear) {
            const day = eventDate.getDate();
            const existing = eventsByDate[day] || [];
            if (!existing.includes(e.type)) {
                existing.push(e.type);
            }
            eventsByDate[day] = existing;
        }
    });

    const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
    const startDayOfWeek = firstDayOfMonth.getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const daysInPreviousMonth = new Date(currentYear, currentMonth, 0).getDate();
    const monthName = firstDayOfMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    
    let html = '';
    
    // Previous month days
    const prevMonthStartDay = daysInPreviousMonth - startDayOfWeek + 1;
    for (let i = prevMonthStartDay; i <= daysInPreviousMonth; i++) {
        html += `<span class="text-gray-400 p-2">${i}</span>`;
    }
    
    // Current month days
    for (let i = 1; i <= daysInMonth; i++) {
        const dayDate = new Date(currentYear, currentMonth, i);
        
        // Check if this is today
        const isToday = dayDate.toDateString() === TODAY.toDateString();
        
        let dayClasses = 'p-2 rounded-full cursor-pointer hover:bg-gray-100 relative';
        if (isToday) {
            dayClasses += ' bg-blue-600 text-white font-bold';
        }
        
        let indicatorClasses = '';
        let eventInfo = 'No events';
        if (eventsByDate[i]) {
            const types = eventsByDate[i];
            let primaryType = 'Event';
            if (types.includes('Deadline')) primaryType = 'Deadline';
            if (types.includes('Exam')) primaryType = 'Exam';
            indicatorClasses = `event-indicator type-${primaryType}`;
            eventInfo = `Events: ${types.join(', ')}`;
        }
        
        html += `
            <span class="${dayClasses} ${indicatorClasses}" 
                  onclick="showToast('Date: ${dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}. ${eventInfo}', 'info')">
                ${i}
            </span>
        `;
    }

    const totalDaysRendered = (startDayOfWeek + daysInMonth);
    const remainingCells = 7 * Math.ceil(totalDaysRendered / 7) - totalDaysRendered;

    // Next month days
    for (let i = 1; i <= remainingCells; i++) {
        html += `<span class="text-gray-400 p-2">${i}</span>`;
    }

    return { html, monthName };
}

        window.changeMonth = (offset) => {
             const newDate = new Date(currentCalendarDate.getTime()); 
             newDate.setMonth(newDate.getMonth() + offset);
             newDate.setDate(1); 
             currentCalendarDate = newDate;
             loadContent('schedule');
        }
        
        window.switchStudyTool = (toolName) => {
            currentStudyTool = toolName;
            loadStudyToolsContent(currentMockUser); 
        }

        // --- NEW: Study Tools Logic - Pomodoro ---
        
        let pomodoroInterval = null;
        let timeRemaining = 25 * 60; 
        let isStudyMode = true;

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = seconds % 60;
            return `${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }
        
        window.startPomodoro = () => {
            const timerDisplay = document.getElementById('timer-display');
            const timerBtn = document.getElementById('timer-btn');
            const modeDisplay = document.getElementById('timer-mode');
            
            if (pomodoroInterval) {
                // Pause
                clearInterval(pomodoroInterval);
                pomodoroInterval = null;
                timerBtn.innerHTML = '<i data-lucide="pause" class="w-5 h-5"></i> Pause';
                timerBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                timerBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                lucide.createIcons();
                return;
            }
            
            // Start
            timerBtn.innerHTML = '<i data-lucide="pause" class="w-5 h-5"></i> Pause';
            timerBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            timerBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            lucide.createIcons();
            
            pomodoroInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.innerText = formatTime(timeRemaining);

                if (timeRemaining <= 0) {
                    clearInterval(pomodoroInterval);
                    pomodoroInterval = null;
                    
                    if (isStudyMode) {
                        window.showToast("Study session complete! Time for a 5-minute break.", 'info');
                        isStudyMode = false;
                        timeRemaining = 5 * 60; // 5 minute break
                        modeDisplay.innerText = 'Break Time';
                    } else {
                        window.showToast("Break over! Starting the next 25-minute study session.", 'success');
                        isStudyMode = true;
                        timeRemaining = 25 * 60; // 25 minute study
                        modeDisplay.innerText = 'Study Session';
                    }
                    
                    timerDisplay.innerText = formatTime(timeRemaining);
                    timerBtn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i> Start';
                    timerBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    timerBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    lucide.createIcons();
                }
            }, 1000);
        }

        window.resetPomodoro = () => {
            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            timeRemaining = 25 * 60;
            isStudyMode = true;
            
            document.getElementById('timer-display').innerText = formatTime(timeRemaining);
            document.getElementById('timer-mode').innerText = 'Study Session';
            
            const timerBtn = document.getElementById('timer-btn');
            timerBtn.innerHTML = '<i data-lucide="play" class="w-5 h-5"></i> Start';
            timerBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
            timerBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            lucide.createIcons();
            window.showToast("Pomodoro timer reset to 25:00.", 'info');
        }

        window.saveStudyNotes = (textarea) => {
            localStorage.setItem(STUDY_NOTES_KEY, textarea.value);
            // PUT request to server is skipped as per API comments for this mock
        }

        // --- NEW: Study Tools Logic - Flashcards ---

        function updateFlashcardDisplay() {
            const display = document.getElementById('flashcard-display');
            const textElement = document.getElementById('flashcard-text');
            const sideElement = document.getElementById('flashcard-side');
            const counterElement = document.getElementById('card-counter');

            if (!display || !textElement) return; 

            if (flashcards.length === 0) {
                textElement.innerText = "Click 'Create New Card' below to start!";
                sideElement.innerText = "";
                counterElement.innerText = "0 / 0";
                display.classList.remove('bg-red-500', 'bg-blue-500');
                display.classList.add('bg-gray-400');
                isFrontSide = true;
                return;
            }

            const card = flashcards[currentCardIndex];
            textElement.innerText = isFrontSide ? card.front : card.back;
            sideElement.innerText = isFrontSide ? 'Front (Concept)' : 'Back (Definition)';
            counterElement.innerText = `${currentCardIndex + 1} / ${flashcards.length}`;
            
            if (isFrontSide) {
                display.classList.remove('bg-red-500', 'bg-blue-500', 'bg-gray-400');
                display.classList.add('bg-blue-500');
            } else {
                display.classList.remove('bg-blue-500', 'bg-red-500', 'bg-gray-400');
                display.classList.add('bg-red-500');
            }
        }

        window.flipCard = () => {
            if (flashcards.length === 0) return;
            isFrontSide = !isFrontSide;
            updateFlashcardDisplay();
        }

        window.nextCard = () => {
            if (flashcards.length === 0) return;
            currentCardIndex = (currentCardIndex + 1) % flashcards.length;
            isFrontSide = true; 
            updateFlashcardDisplay();
        }

        window.previousCard = () => {
            if (flashcards.length === 0) return;
            currentCardIndex = (currentCardIndex - 1 + flashcards.length) % flashcards.length;
            isFrontSide = true;
            updateFlashcardDisplay();
        }

        window.submitNewFlashcard = async (e) => {
            e.preventDefault();
            const front = document.getElementById('card-front').value.trim();
            const back = document.getElementById('card-back').value.trim();

            if (!front || !back) {
                showToast('Both the concept and definition fields are required.', 'error');
                return;
            }

            const newCardPayload = { front, back };
            
            try {
                const response = await fetch(`${BASE_URL}/flashcards`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(newCardPayload)
                });
                
                if (response.ok) {
                    await fetchCoreData(); // Re-fetch flashcards
                    currentCardIndex = flashcards.length - 1; 
                    isFrontSide = true;

                    showToast('New flashcard created successfully!', 'success');
                    closeModal('flashcard-modal');
                    document.getElementById('newFlashcardForm').reset();
                    
                    loadContent('study-tools'); 
                } else {
                    window.showToast(`Error: ${await response.json().message}`, 'error');
                }
            } catch (error) {
                 window.showToast('Network error while creating flashcard.', 'error');
            }
        }

        window.openFlashcardModal = () => {
            openModal('flashcard-modal');
        }
        
        // --- NEW: Study Tools Logic - Grade Calculator (Client-side, no API needed) ---

        window.calculateRequiredFinal = () => {
            const currentGrade = parseFloat(document.getElementById('current-grade').value);
            const currentWeight = parseFloat(document.getElementById('current-weight').value);
            const finalWeight = parseFloat(document.getElementById('final-weight').value);
            const targetGrade = parseFloat(document.getElementById('target-grade').value);
            const resultElement = document.getElementById('required-final-result');

            if (isNaN(currentGrade) || isNaN(currentWeight) || isNaN(finalWeight) || isNaN(targetGrade)) {
                resultElement.innerHTML = '<span class="text-red-500 font-medium">Please enter valid numbers for all fields.</span>';
                return;
            }
            
            if (currentWeight + finalWeight > 105) { 
                 resultElement.innerHTML = '<span class="text-red-500 font-medium">Error: Current and final weights sum to more than 100%.</span>';
                 return;
            }
            if (finalWeight === 0) {
                 resultElement.innerHTML = '<span class="text-red-500 font-medium">Final Exam Weight must be greater than 0.</span>';
                 return;
            }
            
            const currentWeightDecimal = currentWeight / 100;
            const finalWeightDecimal = finalWeight / 100;
            
            const currentScore = currentGrade * currentWeightDecimal;
            const requiredFinalScore = targetGrade - currentScore;
            
            const requiredFinalGrade = (requiredFinalScore / finalWeightDecimal).toFixed(2);
            
            let message;
            let colorClass = 'text-blue-600';

            if (requiredFinalGrade > 100) {
                message = `You need a **${requiredFinalGrade}%** on the final. Achieving your target grade is likely impossible.`;
                colorClass = 'text-red-600';
            } else if (requiredFinalGrade < 0) {
                 message = `You need a **0%** on the final. You've already surpassed your target grade!`;
                 colorClass = 'text-blue-600'; // CONVERTED FROM GREEN
            } else {
                message = `You need to score a **${requiredFinalGrade}%** on the final exam to achieve your target ${targetGrade}% overall.`;
            }

            resultElement.innerHTML = `<span class="font-bold text-lg ${colorClass}">${message}</span>`;
        }

        // --- NEW: Eco Impact Logic ---
        
        // Use localEcoLogCache filled by fetchEcoLog API call
        let localEcoLogCache = {};
        
        // Load the log for today from the server
        const fetchEcoLog = async () => {
    try {
        const response = await fetch(`${BASE_URL}/eco-log/daily`, {
            headers: getAuthHeaders()
        });

        if (response.ok) {
            localEcoLogCache = await response.json();
            return localEcoLogCache;
        }

        return { waste: 0, energy: 0, transport: 0, score: 0 };

    } catch (error) {
        console.error("Error fetching eco log:", error);
        return { waste: 0, energy: 0, transport: 0, score: 0 };
    }
};


        window.logEcoAction = async (type) => {
    try {
        const response = await fetch(`${BASE_URL}/eco-log/action/${type}`, {
            method: 'POST',
            headers: getAuthHeaders(),
        });

        if (response.ok) {
            // Backend returns updated log
            localEcoLogCache = await response.json();

            // Re-fetch to ensure sync
            await fetchEcoLog();

            window.showToast(
                `${type.charAt(0).toUpperCase() + type.slice(1)} action logged! Keep up the momentum.`,
                'success'
            );

            // Reload the Eco Impact tab
            loadContent('eco-impact');
        } else {
            const data = await response.json();
            window.showToast(`Error logging action: ${data.message}`, 'error');
        }

    } catch (error) {
        console.error(error);
        window.showToast('Network error while logging eco action.', 'error');
    }
};

        function getEcoBadges(currentScore) {
             // Mocking badge logic is simplified and based only on score since we removed historical mock data
             let currentStreak = 0; // Cannot calculate without historical data
             if (currentScore >= 10) currentStreak = 1; 
             if (currentScore >= 20) currentStreak = 3; 
             if (currentScore >= 50) currentStreak = 7; 

             
             const badges = [];
             if (currentScore > 0) badges.push({ name: "Started Strong", icon: "zap" });
             if (currentScore >= 30) badges.push({ name: "Eco Contributor", icon: "shield-check" });
             
             return {
                 streak: currentStreak,
                 badges: badges
             };
        }
        
        function renderBadgesCard(badgesData) {
            const badgeItems = badgesData.badges.length > 0 ? badgesData.badges.map(b => `
                <div class="flex items-center gap-2 p-3 rounded-lg bg-blue-50 border border-blue-200"> <i data-lucide="${b.icon}" class="w-5 h-5 text-blue-600"></i> <span class="text-sm font-medium text-gray-800">${b.name}</span>
                </div>
            `).join('') : '<p class="text-sm text-gray-500 p-4">No badges yet. Start logging actions to earn rewards!</p>';

            return `
                <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900 flex items-center gap-2">🏆 Eco Impact Badges</h3>
                    </div>
                    <div class="p-4 space-y-2">
                        <div class="p-2 text-center bg-yellow-50 rounded-lg">
                            <span class="text-sm font-semibold text-gray-800">Current Streak:</span>
                            <span class="text-xl font-bold text-yellow-700 ml-2">${badgesData.streak} days</span>
                        </div>
                        ${badgeItems}
                    </div>
                </div>
            `;
        }
        
        function renderActivityFeed(tasks, ecoLog, announcements) {
            
            const activity = [];

            // Add latest announcement if available
            if (announcements.length > 0) {
                 const latestAnn = announcements[0];
                 activity.push({ 
                     type: 'Announcement', 
                     message: `New announcement: **${latestAnn.title}** posted to **${latestAnn.recipient.replace('Grade 10 - Newton', 'G10-N')}**`, 
                     icon: 'megaphone', 
                     color: 'text-blue-600'
                 });
            }

            const completedTasks = tasks.filter(t => t.status.startsWith('Graded:') || t.status === 'Completed');
            completedTasks.slice(0, 2).forEach(t => { 
                 activity.push({ 
                     type: 'Task', 
                     message: `Completed **${t.title}**.`, 
                     icon: 'check-circle', 
                     color: 'text-blue-600' // CONVERTED FROM GREEN
                 });
            });

            if (ecoLog.score > 0) {
                 activity.push({ 
                     type: 'Eco', 
                     message: `Logged **${ecoLog.waste + ecoLog.energy + ecoLog.transport}** eco actions, earning **${ecoLog.score}** points today!`, 
                     icon: 'leaf', 
                     color: 'text-blue-600' // CONVERTED FROM EMERALD
                 });
            } else {
                 activity.push({ 
                     type: 'Eco', 
                     message: `Haven't logged an eco action today. Try logging a sustainable choice!`, 
                     icon: 'alert-triangle', 
                     color: 'text-orange-600'
                 });
            }
            
            if (activity.length === 0) {
                return '<div class="p-4 text-center text-gray-500">No activity to show yet. Start logging your actions or completing tasks!</div>';
            }

            const activityHTML = activity.map(item => `
                <div class="flex items-center gap-3 p-4 hover:bg-gray-50 transition-colors border-b last:border-b-0">
                    <i data-lucide="${item.icon}" class="w-5 h-5 ${item.color} flex-shrink-0"></i>
                    <p class="text-sm text-gray-800">${item.message.replace(/\*\*/g, '<b>').replace(/\*\*/g, '</b>')}</p>
                </div>
            `).join('');

            return `
                <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100">
                        <h3 class="text-lg font-bold text-gray-900">🔔 Today's Activity Feed</h3>
                    </div>
                    <div class="divide-y divide-gray-100">
                        ${activityHTML}
                    </div>
                </div>
            `;
        }
        
        async function loadEcoLogContent(userData) {
            const todayLog = await fetchEcoLog();
            
            const randomFact = "Save energy by turning off lights when leaving a room and unplugging electronics when they are not in use.";
            
            mainContent.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="leaf" class="w-7 h-7 text-blue-600"></i> <div>
                            <h1 class="text-2xl font-bold text-gray-900">Eco Impact Log</h1>
                            <p class="text-gray-500 text-sm">Monitor your daily contribution to sustainability.</p>
                        </div>
                    </div>
                </header>

                <div class="max-w-3xl mx-auto space-y-6">
                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-100 fade-in">
                        
                        <div class="p-4 rounded-xl bg-blue-100 border border-blue-200 flex items-start gap-4 mb-6"> <i data-lucide="check-circle" class="w-8 h-8 text-blue-600 flex-shrink-0 mt-1"></i> <div>
                                <p class="font-bold text-lg text-blue-800">Your Daily Impact</p> <p class="text-sm text-blue-700">You've logged **${todayLog.waste + todayLog.energy + todayLog.transport}** actions today, earning **${todayLog.score}** points!</p> </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 text-center">
                                <i data-lucide="trash-2" class="w-8 h-8 text-blue-500 mx-auto mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800">${todayLog.waste}</p>
                                <p class="text-xs text-gray-500">Waste Reduction Actions</p>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 text-center">
                                <i data-lucide="lightbulb" class="w-8 h-8 text-yellow-600 mx-auto mb-2"></i>
                                <p class="text-2xl font-bold text-gray-800">${todayLog.energy}</p>
                                <p class="text-xs text-gray-500">Energy Saving Actions</p>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 text-center">
                                <i data-lucide="bike" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i> <p class="text-2xl font-bold text-gray-800">${todayLog.transport}</p>
                                <p class="text-xs text-gray-500">Eco Travel Actions</p>
                            </div>
                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 text-center">
                                <i data-lucide="award" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i> <p class="text-2xl font-bold text-gray-800">${todayLog.score}</p>
                                <p class="text-xs text-gray-500">Today's Eco Score</p>
                            </div>
                        </div>
                        
                        <div class="mt-8">
                            <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                                <i data-lucide="plus-circle" class="w-6 h-6 text-blue-600"></i> Log Your Eco Action
                            </h2>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button onclick="logEcoAction('waste')" class="w-full py-3 bg-blue-500 text-white rounded-lg text-md font-bold hover:bg-blue-600 transition-colors"> Log Waste Action (+5 pts)
                                </button>
                                <button onclick="logEcoAction('energy')" class="w-full py-3 bg-blue-500 text-white rounded-lg text-md font-bold hover:bg-blue-600 transition-colors"> Log Energy Action (+5 pts)
                                </button>
                                <button onclick="logEcoAction('transport')" class="w-full py-3 bg-blue-500 text-white rounded-lg text-md font-bold hover:bg-blue-600 transition-colors"> Log Travel Action (+10 pts)
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i data-lucide="info" class="w-6 h-6 text-gray-500"></i> Eco Tip
                        </h2>
                        <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                            <p class="text-sm text-gray-700 font-medium">${randomFact}</p>
                        </div>
                    </div>
                    
                </div>
            `;
            lucide.createIcons();

            const ecoImpactLink = document.getElementById('nav-eco-impact');
            if (ecoImpactLink) {
                 ecoImpactLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
            }
        }


        function loadStudyToolsContent(userData) {
            
            const savedNotes = localStorage.getItem(STUDY_NOTES_KEY) || '';
            
            clearInterval(pomodoroInterval);
            pomodoroInterval = null;
            timeRemaining = 25 * 60;
            isStudyMode = true;
            
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="brain-circuit" class="w-7 h-7 text-blue-600"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Study Tools</h1>
                            <p class="text-gray-500 text-sm">Boost your focus and productivity.</p>
                        </div>
                    </div>
                </div>
                
                <div class="flex bg-gray-100 p-1 rounded-xl mb-6 shadow-inner flex-wrap md:flex-nowrap max-w-4xl mx-auto">
                    <button id="tab-pomodoro" onclick="switchStudyTool('pomodoro')" class="study-tool-tab flex-1 py-3 rounded-lg transition-all text-sm font-medium flex items-center justify-center gap-2">
                        <i data-lucide="timer" class="w-5 h-5"></i> Pomodoro
                    </button>
                    <button id="tab-notes" onclick="switchStudyTool('notes')" class="study-tool-tab flex-1 py-3 rounded-lg transition-all text-sm font-medium flex items-center justify-center gap-2">
                        <i data-lucide="notebook-pen" class="w-5 h-5"></i> Notes
                    </button>
                    <button id="tab-flashcards" onclick="switchStudyTool('flashcards')" class="study-tool-tab flex-1 py-3 rounded-lg transition-all text-sm font-medium flex items-center justify-center gap-2">
                        <i data-lucide="flip-horizontal-2" class="w-5 h-5"></i> Flashcards
                    </button>
                    <button id="tab-calculator" onclick="switchStudyTool('calculator')" class="study-tool-tab flex-1 py-3 rounded-lg transition-all text-sm font-medium flex items-center justify-center gap-2">
                        <i data-lucide="calculator" class="w-5 h-5"></i> Grade Calc
                    </button>
                </div>

                <div id="study-tool-content" class="max-w-4xl mx-auto">
                    </div>
            `;
            
            const activeTool = currentStudyTool;
            const activeTab = document.getElementById(`tab-${activeTool}`);
            if (activeTab) {
                activeTab.classList.remove('text-gray-600', 'hover:bg-gray-50');
                activeTab.classList.add('bg-white', 'text-blue-600', 'shadow-md', 'font-bold');
            }

            const contentContainer = document.getElementById('study-tool-content');
            
            if (activeTool === 'pomodoro') {
                contentContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-100 flex flex-col items-center justify-center space-y-8 fade-in">
                        <div class="text-center">
                            <h2 class="text-xl font-bold text-gray-900">🧠 Pomodoro Timer</h2>
                            <p id="timer-mode" class="text-blue-600 font-semibold text-sm mt-1">Study Session</p>
                        </div>
                        
                        <div class="w-48 h-48 rounded-full bg-blue-50 border-8 border-blue-200 flex items-center justify-center transition-all">
                            <span id="timer-display" class="text-6xl font-extrabold text-gray-800">${formatTime(timeRemaining)}</span>
                        </div>
                        
                        <div class="flex gap-4">
                            <button id="timer-btn" onclick="startPomodoro()" class="px-6 py-3 bg-blue-600 text-white rounded-full font-bold shadow-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                                <i data-lucide="play" class="w-5 h-5"></i> Start
                            </button>
                            <button onclick="resetPomodoro()" class="p-3 border border-gray-300 text-gray-600 rounded-full hover:bg-gray-100 transition-colors">
                                <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                `;
            } else if (activeTool === 'notes') {
                contentContainer.innerHTML = `
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <i data-lucide="notebook-pen" class="w-5 h-5 text-gray-600"></i> Quick Notes Pad
                        </h2>
                        <p class="text-sm text-gray-500 mb-4">Jot down quick reminders or concepts here. Notes auto-save in your browser (localStorage).</p>
                        <textarea 
                            id="study-notes-textarea" 
                            class="w-full h-80 p-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all resize-none text-sm" 
                            placeholder="Start typing your study notes..."
                            oninput="saveStudyNotes(this)"
                        >${savedNotes}</textarea>
                        <div class="mt-3 text-right">
                            <span class="text-xs text-gray-400">Content persists between visits.</span>
                        </div>
                    </div>
                `;
            } else if (activeTool === 'flashcards') {
                contentContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <i data-lucide="flip-horizontal-2" class="w-6 h-6 text-orange-600"></i> Flashcard Practice
                        </h2>
                        <div id="flashcard-content" class="max-w-md mx-auto space-y-4">
                            <div id="flashcard-display" onclick="flipCard()" class="w-full h-48 bg-blue-500 text-white rounded-xl shadow-lg flex items-center justify-center cursor-pointer p-6 text-center transition-transform transform-gpu hover:scale-[1.02] duration-300 relative">
                                <p id="flashcard-text" class="text-2xl font-bold">Loading...</p>
                                <p id="flashcard-side" class="absolute bottom-3 right-4 text-xs font-medium opacity-70">Side</p>
                            </div>
                            <div class="flex justify-between items-center">
                                <button onclick="previousCard()" class="p-3 text-gray-600 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                                <span id="card-counter" class="text-sm font-medium text-gray-600">0 / 0</span>
                                <button onclick="nextCard()" class="p-3 text-gray-600 hover:bg-gray-100 rounded-full"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                            </div>
                            <button onclick="openFlashcardModal()" class="w-full py-3 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 transition-colors flex items-center justify-center gap-2">
                                <i data-lucide="plus-circle" class="w-5 h-5"></i> Create New Card
                            </button>
                        </div>
                    </div>
                `;
                updateFlashcardDisplay(); 
                
            } else if (activeTool === 'calculator') {
                contentContainer.innerHTML = `
                    <div class="bg-white p-8 rounded-xl shadow-md border border-gray-100 fade-in">
                        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                            <i data-lucide="calculator" class="w-6 h-6 text-blue-600"></i> Final Grade Calculator </h2>
                        <p class="text-sm text-gray-500 mb-6 max-w-lg">Calculate the score you need on your final exam to achieve your desired overall grade.</p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                            <div class="space-y-4">
                                <div>
                                    <label for="current-grade" class="block text-sm font-medium text-gray-700 mb-1">Current Grade (%)</label>
                                    <input type="number" id="current-grade" placeholder="e.g., 85" min="0" max="100" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"> </div>
                                <div>
                                    <label for="current-weight" class="block text-sm font-medium text-gray-700 mb-1">Current Grade Weight (%)</label>
                                    <input type="number" id="current-weight" placeholder="e.g., 60" min="0" max="100" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"> </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label for="final-weight" class="block text-sm font-medium text-gray-700 mb-1">Final Exam Weight (%)</label>
                                    <input type="number" id="final-weight" placeholder="e.g., 40" min="0" max="100" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"> </div>
                                <div>
                                    <label for="target-grade" class="block text-sm font-medium text-gray-700 mb-1">Target Overall Grade (%)</label>
                                    <input type="number" id="target-grade" placeholder="e.g., 90" min="0" max="100" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"> </div>
                            </div>
                        </div>
                        
                        <div class="mt-8 pt-4 border-t border-gray-100 flex flex-col items-center">
                            <button onclick="calculateRequiredFinal()" class="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-colors flex items-center gap-2 mb-4"> <i data-lucide="calculator" class="w-5 h-5"></i> Calculate Required Grade
                            </button>
                            <div id="required-final-result" class="text-center p-3">
                                <span class="text-gray-500">Enter your details and click calculate.</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            lucide.createIcons();
            
            const studyToolsLink = document.getElementById('nav-study-tools');
            if (studyToolsLink) {
                 studyToolsLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
            }
        }
        
        // --- NEW: Settings Logic - Card List & Sub-Pages ---

        window.handleProfileUpdate = async (e) => {
            e.preventDefault();
            const newName = document.getElementById('edit-name').value.trim();
            
            if (!newName) {
                window.showToast('Full Name cannot be empty.', 'error');
                return;
            }

            try {
                const response = await fetch(`${BASE_URL}/user/profile`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ name: newName })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update global state and UI
                    currentMockUser.name = data.name;
                    document.getElementById('user-name-display').innerText = data.name;
                    document.getElementById('user-avatar').innerText = data.name.charAt(0);
                    
                    window.showToast('Profile updated successfully!', 'success');
                    // Return to the main settings page after update
                    loadSettingsContent(currentMockUser); 
                } else {
                    window.showToast(`Error updating profile: ${await response.json().message}`, 'error');
                }
            } catch (error) {
                 window.showToast('Network error while updating profile.', 'error');
            }
        }
        
        window.handlePasswordChange = async (e) => {
            e.preventDefault();
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (newPassword !== confirmPassword) {
                 window.showToast('New password and confirmation do not match.', 'error');
                 return;
            }
            if (newPassword.length < 6) {
                 window.showToast('New password must be at least 6 characters long.', 'error');
                 return;
            }

            const payload = { old_password: oldPassword, new_password: newPassword };

            try {
                const response = await fetch(`${BASE_URL}/user/password`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    window.showToast('Password updated successfully! Please log in again with your new password.', 'success');
                    logout(); // Force log out for security
                } else {
                    const data = await response.json();
                    window.showToast(`Error: ${data.message || 'Password update failed.'}`, 'error');
                }
            } catch (error) {
                 window.showToast('Network error while updating password.', 'error');
            }
        }

        // --- NEW SETTINGS SUB-PAGE: Edit Profile ---
        function loadEditProfileContent(userData) {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <button onclick="loadContent('settings')" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Settings
                    </button>
                </div>
                
                <header class="flex items-center gap-3 mb-6">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-700">
                        <i data-lucide="user" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Edit Profile</h1>
                        <p class="text-gray-500 text-sm">Update your name and personal information.</p>
                    </div>
                </header>

                <div class="max-w-xl mx-auto space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 fade-in">
                        <form id="editProfileForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                                <input type="text" id="edit-name" value="${userData.name}" required class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Email (Cannot be changed)</label>
                                <input type="email" id="edit-email" value="${userData.email}" disabled class="w-full px-4 py-3 rounded-lg border border-gray-300 bg-gray-50 text-gray-500">
                            </div>
                            
                            <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center gap-2">
                                <i data-lucide="save" class="w-5 h-5"></i> Save Changes
                            </button>
                        </form>
                    </div>
                </div>
            `;
            lucide.createIcons();
            const form = document.getElementById('editProfileForm');
            if (form) form.addEventListener('submit', handleProfileUpdate);
        }

        // --- NEW SETTINGS SUB-PAGE: Change Password ---
        function loadPasswordChangeContent(userData) {
            mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <button onclick="loadContent('settings')" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Settings
                    </button>
                </div>
                
                <header class="flex items-center gap-3 mb-6">
                    <div class="p-3 rounded-full bg-blue-100 text-blue-700">
                        <i data-lucide="lock" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Change Password</h1>
                        <p class="text-gray-500 text-sm">Ensure your account is secure by setting a new password.</p>
                    </div>
                </header>

                <div class="max-w-xl mx-auto space-y-8">
                    <div class="bg-white p-6 rounded-xl shadow-md border border-gray-100 fade-in">
                        <form id="changePasswordForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Current Password</label>
                                <input type="password" id="old-password" required class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none focus:border-blue-500" placeholder="••••••••">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">New Password (Min 6 characters)</label>
                                <input type="password" id="new-password" required minlength="6" class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none focus:border-blue-500" placeholder="••••••••">
                            </div>

                             <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Confirm New Password</label>
                                <input type="password" id="confirm-password" required minlength="6" class="w-full px-4 py-3 rounded-lg border border-gray-300 outline-none focus:border-blue-500" placeholder="••••••••">
                            </div>
                            
                            <button type="submit" class="w-full py-3 bg-red-600 text-white rounded-lg font-bold shadow-md hover:bg-red-700 transition-all flex justify-center items-center gap-2">
                                <i data-lucide="lock" class="w-5 h-5"></i> Change Password
                            </button>
                        </form>
                    </div>
                </div>
            `;
            lucide.createIcons();
            const form = document.getElementById('changePasswordForm');
            if (form) form.addEventListener('submit', handlePasswordChange);
        }


        // --- MAIN SETTINGS PAGE (Card List View) ---
        function loadSettingsContent(userData) {
    const isDarkMode = document.body.classList.contains('dark');
    
    mainContent.innerHTML = `
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <i data-lucide="settings" class="w-7 h-7 text-blue-600"></i>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Settings</h1>
                    <p class="text-gray-500 text-sm">Manage your account and preferences</p>
                </div>
            </div>
        </header>

        <div class="max-w-2xl mx-auto space-y-6">
            <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden fade-in">
                <div class="p-6 border-b border-gray-100 bg-gray-50">
                    <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                        Account Settings
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Manage your personal information and security</p>
                </div>
                
                <div class="divide-y divide-gray-100">
                    <button onclick="loadContent('edit-profile')" class="w-full p-6 flex items-center justify-between hover:bg-gray-50 transition-colors text-left">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center flex-shrink-0">
                                <i data-lucide="user" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 text-sm">Profile Information</p>
                                <p class="text-sm text-gray-500 truncate">Update your name and personal details</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 flex-shrink-0"></i>
                    </button>
                    
                    <button onclick="loadContent('change-password')" class="w-full p-6 flex items-center justify-between hover:bg-gray-50 transition-colors text-left">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-12 h-12 rounded-lg bg-red-100 flex items-center justify-center flex-shrink-0">
                                <i data-lucide="lock" class="w-6 h-6 text-red-600"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 text-sm">Change Password</p>
                                <p class="text-sm text-gray-500 truncate">Update your account password for security</p>
                            </div>
                        </div>
                        <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400 flex-shrink-0"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden fade-in">
                <div class="p-6 border-b border-gray-100 bg-gray-50">
                    <h2 class="text-lg font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="palette" class="w-5 h-5 text-purple-600"></i>
                        Appearance & Preferences
                    </h2>
                    <p class="text-sm text-gray-500 mt-1">Customize your StuFlow experience</p>
                </div>
                
                <div class="p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-12 h-12 rounded-lg bg-purple-100 flex items-center justify-center flex-shrink-0">
                                <i data-lucide="moon" class="w-6 h-6 text-purple-600"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 text-sm">Dark Mode</p>
                                <p class="text-sm text-gray-500">Switch between light and dark theme</p>
                            </div>
                        </div>
                        <div onclick="toggleDarkMode()" id="theme-toggle-settings" class="theme-switch-container flex-shrink-0" role="switch" aria-checked="${isDarkMode ? 'true' : 'false'}">
                            <span class="slider"></span>
                            <div class="icon icon-sun" style="transform: translateX(2px); opacity: ${isDarkMode ? 0 : 1};">
                                <i data-lucide="sun" class="w-4 h-4 text-yellow-500"></i>
                            </div>
                            <div class="icon icon-moon" style="transform: translateX(2px); opacity: ${isDarkMode ? 1 : 0};">
                                <i data-lucide="moon" class="w-4 h-4 text-white"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    lucide.createIcons();
    
    // Set active nav link
    const navLink = document.getElementById('nav-settings');
    if (navLink) navLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
}

        // --- NEW: Teacher Dashboard Logic ---
        
        // REWRITTEN TO USE LIVE DATA
        function synthesizeTeacherMetrics(tasks, events, classes) {
            
            // Calculate Total Students from API data
            const totalStudents = classes.reduce((sum, cls) => sum + cls.estimated_students, 0); 

            // Pending Submissions: Count of un-graded submissions
            const pendingSubmissions = currentSubmissions.filter(s => s.status === 'Submitted').length;
            
            // Tasks Due Today: Count of incomplete tasks due on the simulation date
            const tasksDueToday = tasks.filter(task => {
                if (task.status.startsWith('Graded:')) return false;
                if (task.status === 'Completed') return false;
                if (!task.due) return false;
                const taskDate = new Date(task.due + 'T00:00:00');
                return taskDate.getTime() === TODAY.getTime();
            }).length;

            
            // Mock recent submissions based on live data
            const recentSubmissions = currentSubmissions
                .sort((a, b) => new Date(b.date_submitted) - new Date(a.date_submitted)) 
                .slice(0, 4);

            return {
                activeClasses: classes.length,
                totalStudents: totalStudents,
                pendingSubmissions: pendingSubmissions,
                tasksDueToday: tasksDueToday, 
                recentSubmissions: recentSubmissions,
                recentAnnouncements: teacherAnnouncements 
            };
        }
        
        function createAnnouncementItem(item) {
            let color = item.recipient.includes('All') ? 'bg-blue-50' : 'bg-blue-50'; // CONVERTED FROM GREEN
            let icon = item.recipient.includes('All') ? 'megaphone' : 'users';

            return `
                <div class="p-4 flex items-start justify-between hover:bg-gray-50 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="p-2 rounded-lg bg-gray-100 text-gray-600 flex-shrink-0">
                            <i data-lucide="${icon}" class="w-4 h-4 text-gray-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-800 text-sm truncate">${item.title}</p>
                            <p class="text-xs text-gray-500 truncate">${item.message}</p>
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end flex-shrink-0">
                         <span class="text-xs px-2 py-0.5 rounded-full font-medium ${color} text-gray-700">
                            ${item.recipient.replace('Grade 10 - Newton', 'G10-N')}
                         </span>
                         <p class="text-xs text-gray-400 mt-1">${formatDate(item.date)}</p>
                    </div>
                </div>
            `;
        }

        function renderRecentAnnouncementsCard(announcements) {
            const announcementsToRender = announcements.slice(0, 4);
            
            const announcementListHTML = announcementsToRender.length > 0
                ? announcementsToRender.map(createAnnouncementItem).join('')
                : `<div class="p-8 text-center text-gray-500">
                        <i data-lucide="bell" class="w-8 h-8 mx-auto text-blue-500 mb-2"></i>
                        <p class="font-medium">No recent announcements posted yet.</p>
                    </div>`;

            return `
                <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-gray-900">📢 Recent Announcements</h3>
                        <button onclick="openModal('announcement-post-modal')" class="text-sm font-semibold text-blue-600 hover:text-blue-700">Post New</button>
                    </div>
                    <div class="divide-y divide-gray-100">
                        ${announcementListHTML}
                    </div>
                     <div class="p-4 border-t border-gray-100">
                        <button onclick="renderAnnouncementList()" class="text-sm font-semibold text-blue-600 hover:text-blue-700 w-full text-center">
                            View All Announcements
                        </button>
                    </div>
                </div>
            `;
        }

        // --- NEW TEACHER ROLE CONTENT PAGES ---

        // NEW HELPER: Render Announcement Form Content
        function renderAnnouncementForm() {
            const container = document.getElementById('announcement-form-container');
            const classOptionsHTML = classRoster.map(c => 
                `<option value="${c.name}">${c.name}</option>`
            ).join('');

            container.innerHTML = `
                <form id="announcementForm" onsubmit="handleAnnouncementSubmission(event)" class="p-6 space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Title</label>
                        <input type="text" id="announcement-title" placeholder="Short summary of the announcement..." class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none"> </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Message</label>
                        <textarea rows="4" id="announcement-message" placeholder="Enter the detailed message for students." class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none"></textarea> </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Recipient Options</label>
                        <select id="announcement-recipient" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 outline-none"> <option value="Select Class/Section">Select Class/Section</option>
                            <option value="All Classes">All Classes</option>
                            ${classOptionsHTML}
                        </select>
                    </div>

                    <div class="flex justify-end pt-2">
                        <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold shadow-md hover:bg-blue-700 flex items-center gap-2"> <i data-lucide="send" class="w-5 h-5"></i> POST
                        </button>
                    </div>
                </form>
            `;
            lucide.createIcons();
        }

        // NEW HELPER: Render Announcement List Content (for Modal)
        function renderAnnouncementList() {
            const listContainer = document.getElementById('announcement-list-container');
            const subtitle = document.getElementById('announcement-list-subtitle');
            
            if (teacherAnnouncements.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-10 text-center text-gray-500">
                        <i data-lucide="bell" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <p class="font-bold">No Announcements Found</p>
                        <p>No announcements have been posted yet.</p>
                    </div>
                `;
                subtitle.innerText = "No announcements posted.";
            } else {
                const listItemsHTML = teacherAnnouncements.map(createAnnouncementItem).join('');
                listContainer.innerHTML = listItemsHTML;
                subtitle.innerText = `${teacherAnnouncements.length} announcements posted.`;
            }
            // Calls openModal which now handles the icon creation with a delay for performance.
            openModal('announcement-list-modal');
        }

        // NEW: Student Announcement List
        window.renderStudentAnnouncementList = () => {
            const listContainer = document.getElementById('announcement-list-container');
            const subtitle = document.getElementById('announcement-list-subtitle');
            
            if (teacherAnnouncements.length === 0) {
                listContainer.innerHTML = `
                    <div class="p-10 text-center text-gray-500">
                        <i data-lucide="bell" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <p class="font-bold">No Announcements Found</p>
                        <p>No announcements have been posted yet.</p>
                    </div>
                `;
                subtitle.innerText = "No announcements posted.";
            } else {
                const listItemsHTML = teacherAnnouncements.map(ann => `
                    <div class="p-4 flex items-start justify-between hover:bg-gray-50 transition-colors border-b border-gray-100">
                        <div class="flex items-start gap-3">
                            <div class="p-2 rounded-lg bg-blue-100 text-blue-600 flex-shrink-0">
                                <i data-lucide="megaphone" class="w-4 h-4"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-semibold text-gray-800 text-sm">${ann.title}</p>
                                <p class="text-xs text-gray-500 mt-1">${ann.message}</p>
                                <p class="text-xs text-gray-400 mt-1">From: Teacher | Class: ${ann.recipient}</p>
                            </div>
                        </div>
                        <div class="text-right flex flex-col items-end flex-shrink-0">
                            <p class="text-xs text-gray-400">${formatDate(ann.date)}</p>
                        </div>
                    </div>
                `).join('');
                listContainer.innerHTML = listItemsHTML;
                subtitle.innerText = `${teacherAnnouncements.length} announcements available.`;
            }
            
            // Update modal title for student view
            document.querySelector('#announcement-list-modal .text-xl').innerText = 'All Announcements';
            openModal('announcement-list-modal');
        }

        async function handleNewClassSubmission(event) {
             event.preventDefault();
             
             const name = document.getElementById('class-name').value.trim();
             const size = parseInt(document.getElementById('class-size').value, 10);
             
             if (!name) {
                 window.showToast('Class name is required.', 'error');
                 return;
             }
             
             const newClassPayload = { name, size };

             try {
                const response = await fetch(`${BASE_URL}/classes`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(newClassPayload)
                });
                
                if (response.ok) {
                    closeModal('add-class-modal');
                    await fetchCoreData(); // 1. Re-fetch all data (tasks, classes, events)
                    
                    // 2. FIX: Explicitly call loadClassesContent and Dashboard to refresh ALL relevant views
                    loadClassesContent(); 
                    loadDashboardContent(currentMockUser); 

                    window.showToast(`New class **'${name}'** created!`, 'success');
                } else {
                    const errorData = await response.json();
                    window.showToast(`Error: ${errorData.message || 'Error creating class.'}`, 'error');
                }
            } catch (error) {
                 window.showToast('Network error while creating class. Check if the Flask server is running!', 'error');
            }
        }
        
        // Placeholder for "View Roster"
        function loadRosterPlaceholderContent(classInfo) {
             mainContent.innerHTML = `
                <div class="flex justify-between items-center mb-8">
                    <button onclick="loadContent('classes-placeholder')" class="flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i> Back to Classes
                    </button>
                </div>
                <header class="flex items-center gap-3 mb-6">
                    <div class="p-3 rounded-full bg-purple-100 text-purple-700">
                        <i data-lucide="book-open-text" class="w-6 h-6"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Roster: ${classInfo.name}</h1>
                        <p class="text-gray-500 text-sm">Managing the ${classInfo.id} student list.</p>
                    </div>
                </header>
                 <div class="p-10 bg-white rounded-xl shadow-sm border border-gray-100 text-center">
                    <i data-lucide="users" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                    <h3 class="font-bold text-gray-800 text-lg">Student Roster Management</h3>
                    <p class="text-gray-500">This is the roster view for **${classInfo.name}**. Functionality for adding/removing students and viewing grades is under development.</p>
                </div>
             `;
             lucide.createIcons();
        }

        function loadClassesContent() {
            const classesToRender = classRoster;
            
            const classListHTML = classesToRender.map(c => `
                <div class="p-5 bg-white rounded-xl shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-lg bg-purple-100 text-purple-600">
                            <i data-lucide="book-open-text" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <p class="font-bold text-gray-800">${c.name}</p>
                            <p class="text-sm text-gray-500">${c.estimated_students} Estimated Students (ID: ${c.id})</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="loadContent('roster-placeholder', { id: '${c.id}', name: '${c.name}' })" class="px-3 py-2 text-sm text-gray-600 border border-gray-300 rounded-lg hover:bg-gray-50">View Roster</button>
                        <button onclick="openModal('task-modal')" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">Post Task</button>
                    </div>
                </div>
            `).join('');
            
            const classContent = classesToRender.length > 0 ? classListHTML : `
                <div class="p-10 bg-white rounded-xl shadow-sm border border-gray-100 text-center">
                    <i data-lucide="info" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                    <h3 class="font-bold text-gray-800 text-lg">No Active Classes Found</h3>
                    <p class="text-gray-500">Create your first class by clicking the **Add New Class** button above.</p>
                </div>
            `;

            mainContent.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="book-open" class="w-7 h-7 text-blue-600"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Manage Classes</h1>
                            <p class="text-gray-500 text-sm">View, manage, and communicate with your class sections.</p>
                        </div>
                    </div>
                </header>

                <div class="max-w-3xl mx-auto space-y-6">
                    <button onclick="openModal('add-class-modal')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center gap-2"> <i data-lucide="plus" class="w-5 h-5"></i> Add New Class
                    </button>
                    
                    <h2 class="text-md font-semibold text-gray-700 mt-8">Active Class List</h2>
                    <div class="space-y-3">
                        ${classContent}
                    </div>
                </div>
            `;
            lucide.createIcons();
            
            // Set active nav link
            const navLink = document.getElementById('nav-classes-placeholder');
            if (navLink) navLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
        }

        // Add mock submission handler for teacher assignment creation
        window.handleNewAssignmentSubmission = (e) => {
            e.preventDefault();
            // This function is no longer needed as task submission is handled by submitNewTask (which now handles the teacher task distribution logic)
        }

        function loadSubmissionsContent() {
            
            const pendingSubmissions = currentSubmissions
                .filter(sub => sub.status === 'Submitted'); 
                    
            const gradedSubmissions = currentSubmissions
                .filter(sub => sub.status === 'Graded');

            // Content for the current tab (Default to Pending)
            const submissionListHTML = pendingSubmissions.length > 0 ? pendingSubmissions.map(item => createTeacherSubmissionItem(item, true)).join('') : `
                <div class="p-10 text-center text-gray-500">
                    <i data-lucide="check-check" class="w-12 h-12 mx-auto text-blue-500 mb-4"></i> <p class="font-bold">No Pending Submissions to Grade!</p>
                </div>
            `;


            mainContent.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="folder-check" class="w-7 h-7 text-orange-600"></i>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900">Assignment Submissions</h1>
                            <p class="text-gray-500 text-sm">Review, grade, and return student work.</p>
                        </div>
                    </div>
                </header>

                <div class="max-w-4xl mx-auto">
                    <div class="flex bg-gray-100 p-1 rounded-xl mb-6 shadow-inner">
                        <button id="tab-pending" onclick="renderSubmissionList('pending')" class="submission-tab flex-1 py-2 rounded-lg transition-all text-sm font-bold bg-white text-blue-600 shadow-sm">Pending (${pendingSubmissions.length})</button>
                        <button id="tab-graded" onclick="renderSubmissionList('graded')" class="submission-tab flex-1 py-2 rounded-lg transition-all text-sm font-medium text-gray-500 hover:bg-gray-50">Graded (${gradedSubmissions.length})</button>
                        <button id="tab-late" onclick="renderSubmissionList('late')" class="submission-tab flex-1 py-2 rounded-lg transition-all text-sm font-medium text-gray-500 hover:bg-gray-50">Late (0)</button>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                        <div id="submission-list" class="divide-y divide-gray-100">
                           ${submissionListHTML}
                        </div>
                    </div>
                </div>
            `;
            
            // Add rendering function to handle tab switching
            window.renderSubmissionList = (tab) => {
                document.querySelectorAll('.submission-tab').forEach(btn => {
                    btn.classList.remove('bg-white', 'text-blue-600', 'shadow-sm', 'font-bold');
                    btn.classList.add('text-gray-500', 'hover:bg-gray-50', 'font-medium');
                });
                
                const selectedBtn = document.getElementById(`tab-${tab}`);
                selectedBtn.classList.remove('text-gray-500', 'hover:bg-gray-50', 'font-medium');
                selectedBtn.classList.add('bg-white', 'text-blue-600', 'shadow-sm', 'font-bold');

                const container = document.getElementById('submission-list');
                let html = '';
                let list = [];

                if (tab === 'pending') {
                    list = pendingSubmissions;
                } else if (tab === 'graded') {
                    list = gradedSubmissions;
                } else if (tab === 'late') {
                    list = []; // Mock empty for late tab
                }

                if (list.length === 0) {
                     html = `
                        <div class="p-10 text-center text-gray-500">
                            <i data-lucide="check-check" class="w-12 h-12 mx-auto text-blue-500 mb-4"></i> <p class="font-bold">No submissions found in the '${tab.charAt(0).toUpperCase() + tab.slice(1)}' category.</p>
                        </div>
                     `;
                } else {
                    html = list.map(item => createTeacherSubmissionItem(item, tab === 'pending')).join('');
                }
                
                container.innerHTML = html;
                lucide.createIcons();
            }
            
            lucide.createIcons();
            const navLink = document.getElementById('nav-submissions-placeholder');
            if (navLink) navLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
        }

        // FULLY IMPLEMENTED ANNOUNCEMENT POSTING
        window.handleAnnouncementSubmission = (e) => {
            e.preventDefault();
            const title = document.getElementById('announcement-title').value.trim();
            const message = document.getElementById('announcement-message').value.trim();
            const recipient = document.getElementById('announcement-recipient').value;
            
            if (!title || !message || recipient === "Select Class/Section") {
                showToast('Title, Message, and a valid Recipient are required.', 'error');
                return;
            }

            const newAnnouncement = {
                title: title,
                message: message,
                recipient: recipient,
            };
            
            fetch(`${BASE_URL}/announcements`, {
                 method: 'POST',
                 headers: getAuthHeaders(),
                 body: JSON.stringify(newAnnouncement)
            })
            .then(res => res.json())
            .then(async (data) => {
                if (data.message.includes('successfully')) {
                    showToast(`Announcement **"${title}"** posted successfully!`, 'success');
                    e.target.reset();
                    closeModal('announcement-post-modal'); // <-- CORRECT MODAL CLOSE
                    await fetchCoreData();
                    loadContent('dashboard'); 
                } else {
                    showToast(data.message || 'Error posting announcement.', 'error');
                }
            })
            .catch(() => showToast('Network error while posting announcement.', 'error'));
        }

        // --- NEW RESOURCE ENDPOINT HANDLERS ---
        
        window.handleResourceUpload = async (e) => {
            e.preventDefault();
            
            const fileInput = document.getElementById('resource-upload-file');
            const className = document.getElementById('resource-upload-class').value; 
            
            if (fileInput.files.length === 0) {
                window.showToast('Please select a file to upload.', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('resource_file', fileInput.files[0]); 
            formData.append('class_name', className); 
            
            try {
                const response = await fetch(`${BASE_URL}/resources/upload`, {
                    method: 'POST',
                    headers: getFileAuthHeaders(), 
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    document.getElementById('resourceUploadForm').reset();
                    closeModal('resource-upload-modal');
                    
                    await fetchCoreData(); 
                    loadResourcesContent(); // Refresh view
                    loadDashboardContent(currentMockUser);
                    window.showToast(data.message, 'success');
                } else {
                     window.showToast(`Upload Error: ${data.message}`, 'error');
                }
            } catch (error) {
                window.showToast('Network error while uploading resource.', 'error');
            }
        }
        
        function renderResourceItem(resource) {
            let color = resource.class_name.includes('All') ? 'bg-blue-50' : 'bg-blue-50'; // CONVERTED FROM GREEN

            return `
                <div class="p-4 flex items-start justify-between hover:bg-gray-50 transition-colors border-b border-gray-100 last:border-b-0">
                    <div class="flex items-start gap-3">
                        <i data-lucide="file-text" class="w-5 h-5 text-gray-500 flex-shrink-0 mt-1"></i>
                        <div class="flex-1 min-w-0">
                            <p class="font-semibold text-gray-800 text-sm truncate">${resource.file_name}</p>
                            <p class="text-xs text-gray-500">
                                Shared by: ${resource.teacher_name} | Uploaded: ${resource.date_uploaded}
                            </p>
                        </div>
                    </div>
                    <div class="text-right flex flex-col items-end flex-shrink-0">
                         <span class="text-xs px-2 py-0.5 rounded-full font-medium ${color} text-gray-700">
                            ${resource.class_name}
                         </span>
                         <button class="text-blue-600 hover:text-blue-700 text-sm font-semibold flex items-center gap-1 mt-1">
                            <i data-lucide="download" class="w-4 h-4"></i> Download
                         </button>
                    </div>
                </div>
            `;
        }

        function loadResourcesContent() {
             
            const isTeacher = currentMockUser.role === 'teacher';
            const pageTitle = isTeacher ? 'Class Resources (Teacher View)' : 'Shared Class Resources';
            const description = isTeacher ? 'Manage and share handouts, slides, and files with your students.' : 'Files and documents shared by your teachers.';
            
            const uploadButton = isTeacher ? `
                 <button onclick="openModal('resource-upload-modal')" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center gap-2 mb-6"> <i data-lucide="upload" class="w-5 h-5"></i> Upload New Resource
                </button>
            ` : '';
            
            const resourcesListHTML = sharedResources.length > 0 ? sharedResources.map(renderResourceItem).join('') : `
                 <div class="p-10 text-center text-gray-500">
                    <i data-lucide="file-question" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                    <p class="font-bold">No Shared Resources Found</p>
                    <p>${isTeacher ? 'Click "Upload New Resource" to share a file.' : 'Your teachers have not shared any files yet.'}</p>
                </div>
            `;

            mainContent.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-3">
                        <i data-lucide="folder-open" class="w-7 h-7 text-blue-600"></i> <div>
                            <h1 class="text-2xl font-bold text-gray-900">${pageTitle}</h1>
                            <p class="text-gray-500 text-sm">${description}</p>
                        </div>
                    </div>
                </header>

                <div class="max-w-4xl mx-auto space-y-6">
                    ${uploadButton}
                    
                    <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                        <div class="p-4 border-b border-gray-100 bg-gray-50">
                            <p class="text-sm font-semibold text-gray-700">Resource Files (${sharedResources.length})</p>
                        </div>
                        <div id="resources-list" class="divide-y divide-gray-100">
                           ${resourcesListHTML}
                        </div>
                    </div>
                </div>
            `;
            
            lucide.createIcons();
            const navLink = document.getElementById('nav-resources');
            if (navLink) navLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
        }


        // --- Navigation Rendering Logic (Dynamic Sidebar) ---
        function renderNavigation(role) {
            const navContainer = document.getElementById('dynamic-nav');
            let navHTML = '';

            if (role === 'student') {
                navHTML = `
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Core Academics</p>
                    <a href="#" onclick="loadContent('dashboard')" id="nav-dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                    </a>
                    <a href="#" onclick="loadContent('schedule')" id="nav-schedule" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="calendar" class="w-5 h-5"></i> Schedule
                    </a>
                    <a href="#" onclick="loadContent('assignments')" id="nav-assignments" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="file-text" class="w-5 h-5"></i> Assignments
                    </a>

                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mt-4 mb-2">Resources & Tools</p>
                    <a href="#" onclick="loadContent('resources')" id="nav-resources" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="folder-open" class="w-5 h-5"></i> Shared Resources
                    </a>
                    <a href="#" onclick="loadContent('study-tools')" id="nav-study-tools" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="brain-circuit" class="w-5 h-5"></i> Study Tools
                    </a>

                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mt-4 mb-2">Account & Impact</p>
                    <a href="#" onclick="loadContent('eco-impact')" id="nav-eco-impact" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="leaf" class="w-5 h-5"></i> Eco Impact
                    </a>
                    <a href="#" onclick="loadContent('settings')" id="nav-settings" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="settings" class="w-5 h-5"></i> Settings
                    </a>
                `;
            } else { // Teacher Role
                navHTML = `
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Classroom Management</p>
                    <a href="#" onclick="loadContent('dashboard')" id="nav-dashboard" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
                    </a>
                    <a href="#" onclick="loadContent('classes-placeholder')" id="nav-classes-placeholder" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="book-open" class="w-5 h-5"></i> Manage Classes
                    </a>
                    <a href="#" onclick="openModal('task-modal')" id="nav-assignment-creation-placeholder" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="plus-circle" class="w-5 h-5"></i> Create Task
                    </a>
                    <a href="#" onclick="loadContent('submissions-placeholder')" id="nav-submissions-placeholder" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="folder-check" class="w-5 h-5"></i> Submissions
                    </a>
                    <a href="#" onclick="loadContent('resources')" id="nav-resources" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="folder-open" class="w-5 h-5"></i> Class Resources
                    </a>

                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mt-4 mb-2">Data & Account</p>
                    <a href="#" onclick="loadContent('settings')" id="nav-settings" class="flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50">
                        <i data-lucide="settings" class="w-5 h-5"></i> Settings
                    </a>
                `;
            }
            
            navContainer.innerHTML = navHTML;
            lucide.createIcons();
        }

        // --- Content Switching Logic ---

        window.loadContent = async (section, data = {}) => {
            lastActiveSection = section;

            if (!currentMockUser) {
                 await loadDashboard(); 
                 return;
            }
            // 1. Reset all nav links to inactive style
            document.querySelectorAll('aside nav a').forEach(link => {
                link.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium text-gray-600 hover:bg-gray-50";
            });

            // 2. Set the current link to active style (Handled within content functions for specific pages)
            
            // 3. Load the appropriate content
            if (section === 'dashboard') {
                await fetchCoreData(); 
                loadDashboardContent(currentMockUser); 
            } else if (section === 'schedule') {
                await fetchCoreData(); 
                const { html: scheduleCalendarDates, monthName } = getCalendarDatesHTML(currentCalendarDate, upcomingEvents);
                
                mainContent.innerHTML = `
                    <div class="flex justify-between items-center mb-6">
                        <div class="flex items-center gap-3">
                            <i data-lucide="calendar" class="w-7 h-7 text-blue-600"></i>
                            <div>
                                <h1 class="text-2xl font-bold text-gray-900">Schedule</h1>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 max-w-lg mx-auto mb-8">
                        <div class="flex justify-between items-center mb-4 text-gray-700 font-semibold">
                            <button onclick="changeMonth(-1)" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-left" class="w-5 h-5"></i></button>
                            <span id="schedule-view-month">${monthName}</span>
                            <button onclick="changeMonth(1)" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="chevron-right" class="w-5 h-5"></i></button>
                        </div>
                        
                         <button class="w-full py-3 mb-6 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 transition-all flex justify-center items-center gap-2"
                            onclick="openModal('event-modal')">
                            <i data-lucide="plus" class="w-5 h-5"></i> Add Event
                        </button>
                        
                        <div class="grid grid-cols-7 gap-2 text-center text-sm">
                            <span class="font-bold text-gray-500">Su</span>
                            <span class="font-bold text-gray-500">Mo</span>
                            <span class="font-bold text-gray-500">Tu</span>
                            <span class="font-bold text-gray-500">We</span>
                            <span class="font-bold text-gray-500">Th</span>
                            <span class="font-bold text-gray-500">Fr</span>
                            <span class="font-bold text-gray-500">Sa</span>
                        </div>
                        <div class="grid grid-cols-7 gap-2 text-center text-sm mt-2">
                            ${scheduleCalendarDates}
                        </div>
                    </div>

                    <h2 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i data-lucide="list-checks" class="w-5 h-5 text-gray-600"></i> Upcoming Events
                    </h2>
                    <div id="upcoming-event-list" class="space-y-4 max-w-lg mx-auto">
                        </div>
                `;
                renderScheduleList();
                lucide.createIcons();
                const navLink = document.getElementById('nav-schedule');
                if (navLink) navLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
            } else if (section === 'assignments') {
                await fetchCoreData(); 
                loadAssignmentsContent(); 
            } else if (section === 'documents') {
                 // Document section is removed for all roles.
                 mainContent.innerHTML = createRestrictedPlaceholder("My Documents - Disabled");
                 lucide.createIcons();
                 return;
            } else if (section === 'resources') { // NEW RESOURCE SECTION
                await fetchCoreData();
                loadResourcesContent();
            } else if (section === 'study-tools') {
                 loadStudyToolsContent(currentMockUser); 
            } else if (section === 'eco-impact') {
                 if (currentMockUser.role === 'teacher') {
                      mainContent.innerHTML = createRestrictedPlaceholder("Eco Impact");
                      lucide.createIcons();
                      return;
                 }
                 await loadEcoLogContent(currentMockUser); 
            } else if (section === 'settings') {
                 loadSettingsContent(currentMockUser); 
            } else if (section === 'edit-profile') { // NEW SUB-PAGE
                 loadEditProfileContent(currentMockUser);
            } else if (section === 'change-password') { // NEW SUB-PAGE
                 loadPasswordChangeContent(currentMockUser);
            }
            // 4. Load Teacher-Specific Content
            else if (section === 'classes-placeholder') {
                 await fetchCoreData();
                 loadClassesContent();
            } else if (section === 'assignment-creation-placeholder') {
                 openModal('task-modal'); // Re-direct to open task modal
                 loadContent('dashboard'); 
            } else if (section === 'submissions-placeholder') {
                 await fetchCoreData();
                 loadSubmissionsContent();
            } else if (section === 'announcements-placeholder') {
                 // The announcement feature is now modal-based from the dashboard
                 openModal('announcement-post-modal');
                 loadContent('dashboard'); // Redirects back to dashboard
            } else if (section === 'roster-placeholder') { // NEW
                 loadRosterPlaceholderContent(data);
            }
            // 5. Generic Placeholder/Fallback
            else {
                const title = section.charAt(0).toUpperCase() + section.slice(1);
                mainContent.innerHTML = `
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900" id="welcome-msg">${title}</h1>
                            <p class="text-gray-500 mt-1">View your ${title} information here.</p>
                        </div>
                    </header>

                    <div class="p-10 bg-white rounded-xl shadow-sm border border-gray-100 text-center">
                        <i data-lucide="folder-open" class="w-12 h-12 mx-auto text-gray-400 mb-4"></i>
                        <h3 class="font-bold text-gray-800 text-lg">Coming Soon</h3>
                        <p class="text-gray-500">The ${title} functionality is under development! This is a placeholder.</p>
                    </div>
                `;
                lucide.createIcons();
            }
        };
        
        function createRestrictedPlaceholder(featureName) {
            return `
                <div class="p-10 bg-white rounded-xl shadow-sm border border-red-100 text-center">
                    <i data-lucide="lock" class="w-12 h-12 mx-auto text-red-500 mb-4"></i>
                    <h3 class="font-bold text-gray-800 text-lg">Access Restricted</h3>
                    <p class="text-gray-500">The **${featureName}** feature is currently only available for student accounts.</p>
                    <button onclick="loadContent('dashboard')" class="mt-4 text-blue-600 hover:underline font-medium">Return to Dashboard</button>
                </div>
            `;
        }


        function loadDashboardContent(userData) {
            
            const stats = generateDashboardStats(currentTasks, upcomingEvents, [], classRoster);
            
            if (userData.role === 'student') {
                // STUDENT VIEW
                const ecoLog = localEcoLogCache; 
                const ecoBadgesData = getEcoBadges(ecoLog.score);
                const completionData = calculateCompletionRate();

                const statsHTML = `
                    ${createStatCard('Tasks Due Today', stats.tasksDueToday, 'clock', 'text-orange-500', 'bg-orange-100')}
                    ${createStatCard('Upcoming Exams (7 Days)', stats.upcomingExams, 'book-open', 'text-red-500', 'bg-red-100')}
                    ${createStatCard('Shared Resources', stats.documentsUploaded, 'folder-open', 'text-blue-600', 'bg-blue-100', "loadContent('resources')")} ${createStatCard('Task Completion Rate', `${completionData.rate}%`, 'check-square', 'text-blue-600', 'bg-blue-100')}
                `;

                const dynamicContentHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            ${renderUrgentTasksCard(stats.urgentTasks)}
                            
                            ${renderActivityFeed(currentTasks, localEcoLogCache, teacherAnnouncements)}
                            
                            </div>

                        <div class="lg:col-span-1 space-y-6">
                            ${renderUpcomingEventsCard(stats.upcomingEventsNextWeek.concat(stats.upcomingExams))}
                            ${renderBadgesCard(ecoBadgesData)}
                            ${renderQuickLinksCard()}
                        </div>
                    </div>
                `;
                
                mainContent.innerHTML = `
                    <div class="md:hidden fixed top-0 left-0 w-full bg-white border-b border-gray-200 z-20 p-4 flex justify-between items-center shadow-sm">
                        <span class="font-bold text-xl text-gray-800">StuFlow</span>
                        <button onclick="logout()"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>

                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900" id="welcome-msg">Welcome, ${userData.name.split(' ')[0]}!</h1>
                            <p class="text-gray-500 mt-1">Here's your academic overview.</p>
                        </div>
                    </header>

                    <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        ${statsHTML}
                    </div>

                    ${dynamicContentHTML}
                `; 

            } else {
                // TEACHER VIEW
                
                const metrics = synthesizeTeacherMetrics(currentTasks, upcomingEvents, classRoster);
                
                const statsHTML = `
                    ${createTeacherStatCardNew('Active Classes', metrics.activeClasses, 'users', 'text-blue-600', 'bg-blue-100')}
                    ${createTeacherStatCardNew('Tasks Due Today', metrics.tasksDueToday, 'clock', 'text-orange-600', 'bg-orange-100')}
                    ${createTeacherStatCardNew('Pending Submissions', metrics.pendingSubmissions, 'file-question', 'text-red-600', 'bg-red-100')}
                    ${createTeacherStatCardNew('Total Students', metrics.totalStudents, 'user-check', 'text-blue-600', 'bg-blue-100')} `;
                
                const dynamicContentHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 space-y-6">
                            ${renderRecentAnnouncementsCard(metrics.recentAnnouncements)}

                        </div>

                        <div class="lg:col-span-1 space-y-6">
                            <div class="bg-white rounded-xl shadow-md border border-gray-100 overflow-hidden">
                                <div class="p-6 border-b border-gray-100">
                                    <h3 class="text-lg font-bold text-gray-900">👨‍🏫 Quick Actions</h3>
                                </div>
                                <div class="p-2 space-y-1">
                                    ${createTeacherQuickAccessLink('Manage Classes', 'book-open', 'text-purple-600', 'bg-purple-100', "loadContent('classes-placeholder')")} 
                                    ${createTeacherQuickAccessLink('Create New Assignment', 'plus-circle', 'text-blue-600', 'bg-blue-100', "openModal('task-modal')")}
                                    ${createTeacherQuickAccessLink('Assignment Submissions', 'folder-check', 'text-orange-600', 'bg-orange-100', "loadContent('submissions-placeholder')")}
                                    ${createTeacherQuickAccessLink('Post Announcement', 'megaphone', 'text-blue-600', 'bg-blue-100', "openModal('announcement-post-modal')")} ${createTeacherQuickAccessLink('Class Resources', 'folder-open', 'text-blue-600', 'bg-blue-100', "loadContent('resources')")} </div>
                            </div>
                        </div>
                    </div>
                `;

                mainContent.innerHTML = `
                    <div class="md:hidden fixed top-0 left-0 w-full bg-white border-b border-gray-200 z-20 p-4 flex justify-between items-center shadow-sm">
                        <span class="font-bold text-xl text-gray-800">StuFlow</span>
                        <button onclick="logout()"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>

                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-2xl font-bold text-gray-900" id="welcome-msg">Welcome, Prof. ${userData.name.split(' ')[0]}!</h1>
                            <p class="text-gray-500 mt-1">Your streamlined classroom management dashboard.</p>
                        </div>
                    </header>

                    <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                        ${statsHTML}
                    </div>

                    ${dynamicContentHTML}
                `;
            }
            // --- End Content Generation ---

            lucide.createIcons();
            
            const dashboardLink = document.getElementById('nav-dashboard');
            if (dashboardLink) {
                 dashboardLink.className = "flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium bg-blue-50 text-blue-700";
            }
        }

        async function loadDashboard() {
            const user = await fetchUserProfile();
            if (!user) {
                switchView('auth');
                return;
            }
            
            // For students, fetch EcoLog before core data load, as it's used by the dashboard immediately
            if (user.role === 'student') {
                 await fetchEcoLog();
            }
            
            await fetchCoreData(); // Load all core data (tasks, events, folders, classes, announcements, submissions, resources)
            
            switchView('dashboard');
            
            // Populate User Info
            document.getElementById('user-name-display').innerText = user.name;
            document.getElementById('user-role-display').innerText = user.role;
            document.getElementById('user-avatar').innerText = user.name.charAt(0);
            
            renderNavigation(user.role);
            loadDashboardContent(user);
        }

        // --- Auth Handlers (Now use API) ---

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const btn = e.target.querySelector('button');
            const loader = e.target.querySelector('.loader');
            
            btn.disabled = true;
            loader.classList.remove('hidden');

            try {
                const response = await fetch(`${BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.requires_verification) {
                        currentEmail = email;
                        window.showToast('Verification code sent to your email!', 'success');
                        switchView('verification');
                    } else {
                        // Direct login (if you remove verification requirement)
                        localStorage.setItem(JWT_TOKEN_KEY, data.token);
                        loadDashboard();
                    }
                } else {
                    window.showToast(data.message || 'Login failed.', 'error');
                }
            } catch (error) {
                window.showToast('Network error. Check if the Flask server is running!', 'error');
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const role = document.getElementById('signup-role').value;
            const btn = e.target.querySelector('button');
            const loader = e.target.querySelector('.loader');

            btn.disabled = true;
            loader.classList.remove('hidden');

            try {
                const response = await fetch(`${BASE_URL}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password, role })
                });

                const data = await response.json();

                if (response.ok) {
                    // Suppress toast here to avoid double notification on verification screen
                    switchAuth('login');
                    document.getElementById('login-email').value = email;
                    document.getElementById('login-password').focus();
                } else {
                    window.showToast(data.message || 'Signup failed.', 'error');
                }
            } catch (error) {
                window.showToast('Network error. Could not connect to server.', 'error');
            } finally {
                btn.disabled = false;
                loader.classList.add('hidden');
            }
        });

        window.logout = () => {
            localStorage.removeItem(JWT_TOKEN_KEY);
            currentMockUser = null;
            currentEmail = "";
            clearInterval(pomodoroInterval); 
            pomodoroInterval = null; 
            switchView('auth');
            switchAuth('login');
            window.showToast('Signed out successfully.', 'info');
        };

        // --- Init ---
        
        // Dark Mode Logic
        window.toggleDarkMode = () => {
            const isDark = document.body.classList.toggle('dark');
            localStorage.setItem(DARK_MODE_KEY, isDark ? 'enabled' : 'disabled');
            
            const toggleHeader = document.getElementById('theme-toggle');
            if (toggleHeader) updateToggleSwitch(toggleHeader, isDark);
            
            const toggleSettings = document.getElementById('theme-toggle-settings');
            if (toggleSettings) updateToggleSwitch(toggleSettings, isDark);
            
            lucide.createIcons(); 
        }

        function updateToggleSwitch(toggleElement, isDark) {
             const sunIcon = toggleElement.querySelector('.icon-sun');
             const moonIcon = toggleElement.querySelector('.icon-moon');
             const slider = toggleElement.querySelector('.slider');
            
             toggleElement.setAttribute('aria-checked', isDark ? 'true' : 'false');
                
             if (isDark) {
                 slider.style.transform = 'translateX(24px)';
                 sunIcon.style.opacity = '0';
                 moonIcon.style.opacity = '1';
             } else {
                 slider.style.transform = 'translateX(0)';
                 sunIcon.style.opacity = '1';
                 moonIcon.style.opacity = '0';
             }
        }
        
        function init() {
            if (localStorage.getItem(DARK_MODE_KEY) === 'enabled') {
                document.body.classList.add('dark');
            } else {
                 document.body.classList.remove('dark');
            }
            
            setupOtpInputs();
            
            if (localStorage.getItem(JWT_TOKEN_KEY)) {
                // If a token exists, try to validate and proceed
                switchView('loading');
                setTimeout(() => {
                    loadDashboard();
                }, 1000);
            } else {
                switchView('auth');
            }
            
            document.getElementById('newEventForm').addEventListener('submit', submitNewEvent);
            document.getElementById('newTaskForm').addEventListener('submit', submitNewTask); 
            document.getElementById('newClassForm').addEventListener('submit', handleNewClassSubmission); 
            document.getElementById('submissionForm').addEventListener('submit', submitAssignment); 
            // The gradeSubmissionForm event listener is correctly handled by the inline onsubmit attribute in the HTML.
            // Resource upload is handled by the inline onsubmit attribute in the HTML.
        }

        init();
    </script>
</body>

</html>
